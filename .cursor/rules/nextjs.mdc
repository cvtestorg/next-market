---
alwaysApply: true
---

# Next.js + shadcn/ui + Tailwind CSS + Better Auth 最佳实践指南

本文档基于互联网最佳实践研究和官方文档整理，旨在指导整个项目的开发工作。

## 1. 项目架构与目录结构

### 1.1 Next.js App Router 结构

- **使用 App Router**：优先使用 `app/` 目录而非 `pages/` 目录
- **文件约定**：
  - `page.tsx` - 页面组件，定义路由的 UI
  - `layout.tsx` - 布局组件，定义共享布局结构
  - `loading.tsx` - 加载状态 UI
  - `error.tsx` - 错误边界 UI
  - `not-found.tsx` - 404 页面
- **可选 src 目录**：可以使用 `src/` 目录分离应用代码和配置文件

### 1.2 目录组织建议

```
app/
├── (auth)/              # 路由组，用于认证相关页面
│   ├── sign-in/
│   └── sign-up/
├── (dashboard)/         # 路由组，用于需要认证的页面
│   └── dashboard/
├── api/
│   └── auth/
│       └── [...all]/    # Better Auth API 路由
├── globals.css          # 全局样式
└── layout.tsx           # 根布局

components/
├── ui/                  # shadcn/ui 组件
└── ...                  # 自定义组件

lib/
├── auth.ts              # Better Auth 服务端配置
├── auth-client.ts        # Better Auth 客户端配置
└── utils.ts             # 工具函数
```

## 2. Next.js 配置最佳实践

### 2.1 使用 Server Components 优先

- **默认使用 Server Components**：减少客户端 JavaScript 体积
- **仅在需要时使用 Client Components**：使用 `"use client"` 指令标记需要交互性的组件
- **性能优化**：将客户端边界限制在最小范围内

### 2.2 数据获取策略

- **Server Components 中直接获取数据**：使用 `async/await` 在 Server Components 中获取数据
- **避免不必要的客户端数据获取**：优先在服务端获取数据
- **使用 Server Actions**：用于表单提交和服务器端操作

### 2.3 中间件/代理（Next.js 16+）

- **Next.js 16+ 使用 proxy**：将 `middleware.ts` 重命名为 `proxy.ts`
- **认证检查**：在 proxy 中仅检查 cookie 存在性，完整验证在页面/路由中进行
- **避免阻塞请求**：不要在 proxy 中进行数据库调用

## 3. Tailwind CSS 配置最佳实践

### 3.1 PostCSS 配置

- **使用 PostCSS 插件**：在 `postcss.config.mjs` 中配置 `@tailwindcss/postcss`
- **CSS 导入**：在主 CSS 文件中使用 `@import` 导入 Tailwind

### 3.2 Tailwind 配置

- **启用 CSS 变量**：在 `components.json` 中设置 `tailwind.cssVariables: true`
- **主题配置**：使用 CSS 变量进行主题管理，支持深色模式
- **工具类优先**：优先使用 Tailwind 工具类而非自定义 CSS

### 3.3 样式组织

- **全局样式**：在 `app/globals.css` 中定义全局样式和 CSS 变量
- **组件样式**：使用 Tailwind 工具类直接在组件中应用样式
- **避免内联样式**：除非必要，否则避免使用内联样式

## 4. shadcn/ui 组件使用最佳实践

### 4.1 组件安装

- **使用 CLI 安装**：使用 `npx shadcn@latest add [component]` 安装组件
- **手动安装**：对于自定义需求，可以手动复制组件代码
- **版本管理**：组件代码直接存在于项目中，便于自定义和版本控制

### 4.2 组件使用

- **导入路径**：使用配置的别名 `@/components/ui/[component]`
- **组合使用**：shadcn/ui 组件设计为可组合，可以灵活组合使用
- **自定义样式**：组件代码在项目中，可以直接修改样式

### 4.3 表单处理

- **使用 React Hook Form**：结合 `@hookform/resolvers` 和 `zod` 进行表单验证
- **Server Actions**：使用 Next.js Server Actions 处理表单提交
- **Field 组件**：使用 `<Field />` 组件构建可访问的表单

### 4.4 主题管理

- **CSS 变量**：使用 CSS 变量进行主题配置
- **next-themes**：使用 `next-themes` 进行深色模式切换
- **主题持久化**：在 `layout.tsx` 中配置主题提供者

## 5. Better Auth 集成最佳实践

### 5.1 服务端配置

#### 5.1.1 创建 Auth 实例

```typescript
// lib/auth.ts
import { betterAuth } from "better-auth";
import { nextCookies } from "better-auth/next-js";

export const auth = betterAuth({
  database: {
    // 数据库配置
  },
  emailAndPassword: {
    enabled: true,
  },
  socialProviders: {
    // 社交登录配置
  },
  plugins: [
    // 插件配置
    nextCookies(), // 必须在最后，用于 Server Actions 中的 cookie 设置
  ],
});
```

#### 5.1.2 API 路由配置

```typescript
// app/api/auth/[...all]/route.ts
import { auth } from "@/lib/auth";
import { toNextJsHandler } from "better-auth/next-js";

export const { GET, POST } = toNextJsHandler(auth.handler);
```

### 5.2 客户端配置

#### 5.2.1 创建客户端实例

```typescript
// lib/auth-client.ts
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_APP_URL || "http://localhost:3000",
});
```

#### 5.2.2 使用 Hooks

```typescript
// 在 Client Components 中使用
"use client";

import { authClient } from "@/lib/auth-client";

export function UserProfile() {
  const { data: session, isPending, error } = authClient.useSession();

  if (isPending) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;
  if (!session) return <div>Not authenticated</div>;

  return <div>Welcome, {session.user.name}</div>;
}
```

### 5.3 服务端认证检查

#### 5.3.1 Server Components 中的认证

```typescript
// app/dashboard/page.tsx
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { redirect } from "next/navigation";

export default async function DashboardPage() {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session) {
    redirect("/sign-in");
  }

  return <div>Welcome {session.user.name}</div>;
}
```

#### 5.3.2 Server Actions 中的认证

```typescript
// app/actions.ts
"use server";

import { auth } from "@/lib/auth";
import { headers } from "next/headers";

export async function protectedAction() {
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  if (!session) {
    throw new Error("Unauthorized");
  }

  // 执行受保护的操作
}
```

### 5.4 认证保护最佳实践

#### 5.4.1 Proxy/Middleware（Next.js 16+）

```typescript
// proxy.ts (Next.js 16+)
import { NextRequest, NextResponse } from "next/server";
import { getSessionCookie } from "better-auth/cookies";

export async function proxy(request: NextRequest) {
  const sessionCookie = getSessionCookie(request);

  // 仅检查 cookie 存在性，完整验证在页面中进行
  if (!sessionCookie && request.nextUrl.pathname.startsWith("/dashboard")) {
    return NextResponse.redirect(new URL("/sign-in", request.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/dashboard/:path*"],
};
```

#### 5.4.2 页面级认证检查

- **在每个受保护页面中验证**：不要仅依赖 proxy/middleware
- **使用 Server Components**：在 Server Components 中进行完整会话验证
- **重定向处理**：使用 `redirect()` 函数进行重定向

### 5.5 表单处理最佳实践

#### 5.5.1 登录表单

```typescript
// app/sign-in/page.tsx
"use client";

import { authClient } from "@/lib/auth-client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { useRouter } from "next/navigation";

export default function SignInPage() {
  const router = useRouter();

  const handleSignIn = async (formData: FormData) => {
    const email = formData.get("email") as string;
    const password = formData.get("password") as string;

    const { data, error } = await authClient.signIn.email(
      {
        email,
        password,
      },
      {
        onSuccess: () => {
          router.push("/dashboard");
        },
        onError: (ctx) => {
          alert(ctx.error.message);
        },
      }
    );
  };

  return (
    <form action={handleSignIn}>
      <Input name="email" type="email" placeholder="Email" />
      <Input name="password" type="password" placeholder="Password" />
      <Button type="submit">Sign In</Button>
    </form>
  );
}
```

### 5.6 插件使用

- **根据需要添加插件**：如 2FA、Magic Link、Passkey 等
- **服务器和客户端配置**：插件需要在服务器和客户端都配置
- **数据库迁移**：添加插件后需要运行数据库迁移

## 6. 性能优化最佳实践

### 6.1 代码分割

- **动态导入**：使用 `next/dynamic` 进行代码分割
- **路由级代码分割**：Next.js 自动进行路由级代码分割
- **组件级代码分割**：对于大型组件使用动态导入

### 6.2 图片优化

- **使用 next/image**：使用 Next.js Image 组件进行图片优化
- **懒加载**：默认启用图片懒加载
- **响应式图片**：使用 `sizes` 属性优化响应式图片

### 6.3 字体优化

- **使用 next/font**：使用 Next.js Font 优化进行字体加载
- **字体显示策略**：配置合适的 `display` 策略

### 6.4 缓存策略

- **静态生成**：对于静态内容使用静态生成
- **增量静态再生**：使用 ISR 更新静态内容
- **缓存控制**：合理配置缓存头

## 7. 类型安全最佳实践

### 7.1 TypeScript 配置

- **严格模式**：启用 TypeScript 严格模式
- **类型推断**：充分利用 TypeScript 类型推断
- **类型导出**：从 Better Auth 导出类型用于类型安全

### 7.2 Better Auth 类型

```typescript
import type { auth } from "@/lib/auth";

type Session = typeof auth.$Infer.Session;
type User = typeof auth.$Infer.Session.user;
```

## 8. 错误处理最佳实践

### 8.1 错误边界

- **使用 error.tsx**：在路由级别定义错误边界
- **错误恢复**：提供错误恢复机制
- **错误日志**：记录错误到日志服务

### 8.2 表单错误处理

- **客户端验证**：使用 Zod 进行客户端验证
- **服务器验证**：在 Server Actions 中进行服务器验证
- **错误显示**：使用 shadcn/ui 组件显示错误信息

## 9. 可访问性最佳实践

### 9.1 语义化 HTML

- **使用正确的 HTML 元素**：使用语义化 HTML 元素
- **ARIA 属性**：在需要时使用 ARIA 属性
- **键盘导航**：确保所有交互元素可通过键盘访问

### 9.2 shadcn/ui 可访问性

- **Radix UI 基础**：shadcn/ui 基于 Radix UI，具有内置可访问性
- **焦点管理**：确保焦点管理正确
- **屏幕阅读器支持**：确保屏幕阅读器支持

## 10. 测试最佳实践

### 10.1 单元测试

- **组件测试**：测试独立组件
- **工具函数测试**：测试工具函数
- **类型测试**：使用 TypeScript 进行类型测试

### 10.2 集成测试

- **API 路由测试**：测试 API 路由
- **认证流程测试**：测试认证流程
- **端到端测试**：使用 Playwright 或 Cypress 进行 E2E 测试

## 11. 部署最佳实践

### 11.1 环境变量

- **使用 .env.local**：本地开发使用 `.env.local`
- **环境变量验证**：在应用启动时验证必需的环境变量
- **敏感信息保护**：不要将敏感信息提交到版本控制

### 11.2 构建优化

- **生产构建**：使用 `next build` 进行生产构建
- **构建分析**：使用 `@next/bundle-analyzer` 分析构建产物
- **性能监控**：集成性能监控工具

## 12. 安全最佳实践

### 12.1 认证安全

- **HTTPS**：生产环境必须使用 HTTPS
- **Cookie 安全**：配置安全的 Cookie 属性
- **CSRF 保护**：Better Auth 内置 CSRF 保护

### 12.2 数据安全

- **输入验证**：始终验证用户输入
- **SQL 注入防护**：使用参数化查询
- **XSS 防护**：使用 React 的内置 XSS 防护

## 13. 开发工作流最佳实践

### 13.1 代码组织

- **组件分离**：将组件分离到独立文件
- **工具函数分离**：将工具函数分离到独立文件
- **类型定义**：将类型定义集中管理

### 13.2 Git 工作流

- **提交信息**：编写清晰的提交信息
- **分支策略**：使用功能分支进行开发
- **代码审查**：进行代码审查

### 13.3 开发工具

- **ESLint**：使用 ESLint 进行代码检查
- **Prettier**：使用 Prettier 进行代码格式化
- **TypeScript**：使用 TypeScript 进行类型检查

## 14. 常见问题与解决方案

### 14.1 Better Auth Cookie 问题

- **Server Actions 中的 Cookie**：确保使用 `nextCookies()` 插件
- **跨域 Cookie**：配置正确的 Cookie 属性
- **Cookie 前缀**：如果使用自定义 Cookie 名称，确保配置正确

### 14.2 shadcn/ui 样式问题

- **CSS 变量未生效**：检查 `globals.css` 中的 CSS 变量定义
- **主题切换问题**：确保 `next-themes` 配置正确
- **样式冲突**：检查 Tailwind 配置和组件样式

### 14.3 Next.js 性能问题

- **客户端边界过大**：将客户端边界限制在最小范围
- **不必要的重新渲染**：使用 React.memo 和 useMemo 优化
- **大型组件**：将大型组件拆分为更小的组件

## 15. 参考资源

### 15.1 官方文档

- [Next.js 文档](https://nextjs.org/docs)
- [shadcn/ui 文档](https://ui.shadcn.com)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)
- [Better Auth 文档](https://www.better-auth.com/docs)

### 15.2 示例项目

- [Better Auth Starter](https://github.com/devAaus/better-auth)
- [Next.js Better Auth Example](https://github.com/irfan-arrosid/nextjs-better-auth)

---

**注意**：本文档基于 2024-2025 年的最佳实践，随着技术栈的更新，某些内容可能需要调整。建议定期查阅官方文档获取最新信息。
