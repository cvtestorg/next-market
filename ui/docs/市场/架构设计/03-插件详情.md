# 插件详情模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

插件详情页是用户了解插件详细信息和执行操作的核心页面，负责：
- 展示插件完整信息
- 提供安装/购买/申请权限等操作入口
- 展示版本历史
- 管理插件配置

---

## 2. 页面结构设计

### 2.1 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│  返回链接                                                        │
│  < 返回市场                                                      │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  ┌───────────────────────────────────┐ ┌───────────────────────┐│
│  │                                   │ │                       ││
│  │  插件基本信息区域                  │ │     操作卡片区域       ││
│  │                                   │ │                       ││
│  │  ┌────┐                          │ │  ┌─────────────────┐  ││
│  │  │图标│  插件名称                 │ │  │  操作按钮       │  ││
│  │  └────┘  作者 · 版本              │ │  │  安装/购买/申请 │  ││
│  │                                   │ │  └─────────────────┘  ││
│  │  [官方] [免费] [效率工具]         │ │                       ││
│  │                                   │ │  运行状态：运行中      ││
│  │  插件详细描述...                  │ │  安装时间：2024-01-01  ││
│  │                                   │ │                       ││
│  │  ┌──────┐ ┌──────┐ ┌──────┐    │ │  [启动] [停止] [卸载]  ││
│  │  │下载量│ │ 评分 │ │更新时间│    │ │                       ││
│  │  └──────┘ └──────┘ └──────┘    │ └───────────────────────┘│
│  │                                   │                         │
│  └───────────────────────────────────┘                         │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  [详情] [版本历史] [配置]                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Tab 内容区域                                                    │
│                                                                 │
│  详情 Tab: 插件完整描述、功能介绍、使用说明                       │
│                                                                 │
│  版本历史 Tab: 版本列表、更新日志、发布时间                       │
│                                                                 │
│  配置 Tab: 企业配置表单、个人配置表单                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 组件层级

```
PluginDetailPage (Server Component)
├── BackLink
├── PluginHeader
│   ├── PluginIcon
│   ├── PluginTitle
│   ├── PluginMeta (作者、版本)
│   ├── PluginTags (来源、价格、分类)
│   └── PluginStats (下载量、评分、更新时间)
├── PluginActionCard (Client Component)
│   ├── ActionButtons
│   ├── RunStatus
│   └── ManageButtons
└── PluginTabs (Client Component)
    ├── DetailTab
    ├── VersionHistoryTab
    └── ConfigTab
```

---

## 3. 数据获取设计

### 3.1 页面数据需求

| 数据 | 来源 | 是否需要登录 | 说明 |
|------|------|-------------|------|
| 插件基本信息 | 数据库 | 否 | 名称、描述、作者等 |
| 版本列表 | 数据库 | 否 | 历史版本信息 |
| 用户安装信息 | 数据库 | 是 | 是否安装、运行状态 |
| 权限状态 | 数据库 | 是 | 是否有权限、申请状态 |
| 配置定义 | 数据库 | 是 | 配置项 Schema |
| 配置值 | 数据库 | 是 | 当前配置值 |

### 3.2 数据获取流程

```
页面加载 (pluginId 来自 URL 参数)
    │
    ▼
┌─────────────────────────────────────────┐
│ 获取插件基本信息                         │
│ SELECT * FROM plugins WHERE id = ?      │
└─────────────────────────────────────────┘
    │
    ▼
插件是否存在？ ──── 否 ────→ 显示 404 页面
    │
    是
    │
    ▼
┌─────────────────────────────────────────┐
│ 获取 Session（可选）                     │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 并行获取其他数据 (Promise.all)          │
│                                         │
│ ┌─────────────┐ ┌─────────────┐        │
│ │ 获取版本列表 │ │获取配置Schema│        │
│ └─────────────┘ └─────────────┘        │
│                                         │
│ 以下仅在已登录时获取：                   │
│ ┌─────────────┐ ┌─────────────┐        │
│ │ 获取安装信息 │ │ 获取权限状态 │        │
│ └─────────────┘ └─────────────┘        │
│ ┌─────────────────────────────┐        │
│ │ 获取配置值（企业+个人）       │        │
│ └─────────────────────────────┘        │
└─────────────────────────────────────────┘
    │
    ▼
渲染页面组件
```

---

## 4. 操作卡片设计

### 4.1 操作状态决策树

```
用户是否已登录？
    │
    ├── 否 ────→ 显示"登录后操作"按钮
    │            点击弹出登录提示
    │
    └── 是
            │
            ▼
        用户是否已安装此插件？
            │
            ├── 是 ────→ 显示已安装管理界面
            │            (运行状态、启动/停止/卸载按钮)
            │
            └── 否
                    │
                    ▼
                插件是否是企业插件？
                    │
                    ├── 是
                    │       │
                    │       ▼
                    │   用户是否有权限？
                    │       │
                    │       ├── 是 ────→ 根据价格显示安装/购买按钮
                    │       │
                    │       └── 否
                    │               │
                    │               ▼
                    │           是否有待审核的申请？
                    │               │
                    │               ├── 是 ────→ 显示"审核中"状态
                    │               │
                    │               └── 否
                    │                       │
                    │                       ▼
                    │                   是否有被拒绝的申请？
                    │                       │
                    │                       ├── 是 ────→ 显示"重新申请"按钮
                    │                       │            并展示拒绝原因
                    │                       │
                    │                       └── 否 ────→ 显示"申请权限"按钮
                    │
                    └── 否
                            │
                            ▼
                        插件是否收费？
                            │
                            ├── 是
                            │       │
                            │       ▼
                            │   用户是否已购买？
                            │       │
                            │       ├── 是 ────→ 显示"安装"按钮
                            │       │
                            │       └── 否 ────→ 显示"购买"按钮和价格
                            │
                            └── 否 ────→ 显示"安装"按钮
```

### 4.2 操作卡片状态汇总

| 状态 | 主按钮 | 辅助信息 | 次要操作 |
|------|--------|----------|----------|
| 未登录 | 登录后安装 | - | - |
| 已安装-运行中 | 停止 | 运行状态：运行中 | 卸载 |
| 已安装-已停止 | 启动 | 运行状态：已停止 | 卸载 |
| 已安装-有更新 | 更新到 vX.X.X | 当前版本 → 最新版本 | 启动/停止、卸载 |
| 未安装-免费 | 安装 | 免费 | - |
| 未安装-收费-未购买 | 购买 ¥XX | 一次性购买/按月订阅 | - |
| 未安装-收费-已购买 | 安装 | 已购买 | - |
| 需要权限-未申请 | 申请使用权限 | 需要企业管理员审批 | - |
| 需要权限-审核中 | 等待审批 (禁用) | 您的申请正在审核中 | - |
| 需要权限-被拒绝 | 重新申请 | 拒绝原因：XXX | - |

### 4.3 已安装插件管理界面

```
┌─────────────────────────────────────────┐
│  运行状态                                │
│  ┌─────────────────────────────────────┐│
│  │ ● 运行中                            ││
│  │   启动时间：2024-01-01 10:00        ││
│  └─────────────────────────────────────┘│
│                                         │
│  当前版本：v1.2.0                        │
│  安装时间：2024-01-01                    │
│                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │  启动   │ │  停止   │ │  卸载   │  │
│  └─────────┘ └─────────┘ └─────────┘  │
│                                         │
│  有新版本可用: v1.3.0                   │
│  [更新到最新版本]                        │
└─────────────────────────────────────────┘
```

---

## 5. Tab 内容设计

### 5.1 详情 Tab

**内容结构**
- 插件完整描述（支持 Markdown 渲染）
- 功能特性列表
- 使用说明
- 截图/演示
- 作者信息

### 5.2 版本历史 Tab

**列表项结构**

```
┌─────────────────────────────────────────┐
│  v1.3.0                       2024-01-15│
│  ─────────────────────────────────────  │
│  更新内容:                               │
│  • 新增 XXX 功能                        │
│  • 修复 YYY 问题                        │
│  • 优化 ZZZ 性能                        │
│                                         │
│                           [安装此版本]  │
└─────────────────────────────────────────┘
```

**排序**：按版本号降序，最新版本在前

### 5.3 配置 Tab

**显示条件**：
- 用户已登录
- 用户已安装此插件
- 插件定义了配置项

**内容结构**

```
┌─────────────────────────────────────────┐
│  [企业配置] [个人配置]                   │
├─────────────────────────────────────────┤
│                                         │
│  配置项 1                               │
│  ┌─────────────────────────────────────┐│
│  │ 输入框/选择器/开关                   ││
│  └─────────────────────────────────────┘│
│  说明文字...                            │
│                                         │
│  配置项 2                               │
│  ┌─────────────────────────────────────┐│
│  │ 输入框/选择器/开关                   ││
│  └─────────────────────────────────────┘│
│  说明文字...                            │
│                                         │
│                              [保存配置] │
└─────────────────────────────────────────┘
```

详细配置设计见 [06-插件配置.md](./06-插件配置.md)

---

## 6. 未登录用户处理设计

### 6.1 可见内容

| 内容 | 可见性 | 说明 |
|------|--------|------|
| 插件基本信息 | ✅ 可见 | 名称、描述、作者等 |
| 统计信息 | ✅ 可见 | 下载量、评分等 |
| 详情 Tab | ✅ 可见 | 完整描述 |
| 版本历史 Tab | ✅ 可见 | 所有版本信息 |
| 配置 Tab | ❌ 不可见 | Tab 不显示 |
| 操作按钮 | ✅ 可见 | 显示"登录后操作" |

### 6.2 操作限制

| 操作 | 未登录行为 |
|------|-----------|
| 点击安装 | 弹出登录提示对话框 |
| 点击购买 | 弹出登录提示对话框 |
| 点击申请权限 | 弹出登录提示对话框 |
| 安装指定版本 | 弹出登录提示对话框 |

### 6.3 登录提示对话框

**内容**：
- 标题：需要登录
- 描述：请先登录后再执行此操作
- 按钮：取消 / 去登录

**回调 URL**：当前插件详情页 `/market/plugin/{pluginId}`

---

## 7. 错误处理设计

### 7.1 插件不存在

**触发条件**：根据 pluginId 查询不到插件

**展示内容**：

```
┌─────────────────────────────────────────┐
│                                         │
│              📦                         │
│                                         │
│          插件不存在                      │
│                                         │
│   该插件可能已被删除或从未存在            │
│                                         │
│           [返回市场]                     │
│                                         │
└─────────────────────────────────────────┘
```

### 7.2 数据加载失败

**触发条件**：数据库查询或 API 调用失败

**展示内容**：使用 error.tsx 错误边界，提供重试按钮

---

## 8. 交互设计

### 8.1 操作确认设计

| 操作 | 是否需要确认 | 确认对话框内容 |
|------|-------------|---------------|
| 安装 | 否 | - |
| 卸载 | 是 | 确定要卸载此插件吗？卸载后个人配置将被清除。 |
| 启动 | 否 | - |
| 停止 | 是 | 确定要停止此插件吗？ |
| 更新 | 是 | 确定要更新到 vX.X.X 吗？ |
| 购买 | 是 | 显示购买确认对话框（含价格信息） |
| 申请权限 | 是 | 显示申请对话框（需填写申请理由） |

### 8.2 操作反馈设计

| 操作 | 成功提示 | 失败提示 |
|------|----------|----------|
| 安装 | 「插件名」安装成功 | 安装失败：{错误原因} |
| 卸载 | 「插件名」已卸载 | 卸载失败：{错误原因} |
| 启动 | 「插件名」已启动 | 启动失败：{错误原因} |
| 停止 | 「插件名」已停止 | 停止失败：{错误原因} |
| 更新 | 「插件名」已更新到 vX.X.X | 更新失败：{错误原因} |
| 购买 | 购买成功 | 购买失败：{错误原因} |
| 申请权限 | 申请已提交，等待审批 | 申请失败：{错误原因} |

### 8.3 乐观更新设计

| 操作 | 乐观更新行为 | 失败回滚 |
|------|-------------|---------|
| 安装 | 立即显示"已安装"状态 | 恢复"安装"按钮 |
| 卸载 | 立即显示"安装"按钮 | 恢复"已安装"状态 |
| 启动 | 立即显示"运行中"状态 | 恢复"已停止"状态 |
| 停止 | 立即显示"已停止"状态 | 恢复"运行中"状态 |
