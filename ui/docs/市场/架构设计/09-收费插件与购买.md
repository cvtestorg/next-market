# 收费插件与购买模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

收费插件与购买模块负责处理付费插件的购买流程，包括：
- 购买流程
- 支付集成
- 订阅管理
- 购买记录

---

## 2. 收费模式设计

### 2.1 支持的收费模式

| 模式 | 说明 | 权限有效期 | 续费要求 |
|------|------|------------|----------|
| 一次性购买 | 支付一次，永久使用 | 永久 | 无 |
| 按月订阅 | 按月付费 | 1 个月 | 到期需续费 |
| 按年订阅 | 按年付费 | 1 年 | 到期需续费 |

### 2.2 定价策略

| 模式 | 价格显示 | 优惠说明 |
|------|----------|----------|
| 一次性购买 | ¥XX | - |
| 按月订阅 | ¥XX/月 | - |
| 按年订阅 | ¥XX/年 | 相当于 10 个月价格 |

---

## 3. 购买数据模型

### 3.1 订单记录结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 订单 ID |
| userId | string | 用户 ID |
| pluginId | string | 插件 ID |
| amount | number | 订单金额 |
| priceMode | enum | 收费模式：one-time / monthly / yearly |
| status | enum | 状态：pending / paid / failed / refunded |
| paymentMethod | string | 支付方式 |
| paymentId | string | 支付平台订单号 |
| createdAt | datetime | 创建时间 |
| paidAt | datetime | 支付时间 |

### 3.2 权限记录（复用）

购买成功后创建权限记录：
- grantType = "purchase"
- expireAt = 订阅到期时间（一次性购买为 null）

---

## 4. 购买流程设计

### 4.1 完整购买流程

```
用户点击"购买"按钮
    │
    ▼
检查登录状态
    │
    ├── 未登录 ────→ 弹出登录提示对话框
    │
    └── 已登录
            │
            ▼
        弹出购买确认对话框
        ┌─────────────────────────────────────────┐
        │  购买插件                                │
        │                                         │
        │  ┌─────────────────────────────────────┐│
        │  │ 📦 插件名称                         ││
        │  │    作者名称                         ││
        │  └─────────────────────────────────────┘│
        │                                         │
        │  选择订阅方式（如果支持订阅）            │
        │  ○ 按月订阅    ¥XX/月                  │
        │  ● 按年订阅    ¥XX/年  省 2 个月       │
        │                                         │
        │  ─────────────────────────────         │
        │  合计：¥XX                              │
        │                                         │
        │            [取消]  [确认支付 ¥XX]       │
        └─────────────────────────────────────────┘
            │
            ▼
        用户确认支付
            │
            ▼
        调用创建订单 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 获取插件信息                         │
│ 3. 验证插件可购买                       │
│ 4. 检查是否已购买（且未过期）           │
│ 5. 计算订单金额                         │
│ 6. 创建待支付订单                       │
│ 7. 调用支付网关创建支付                 │
│ 8. 返回支付信息                         │
└─────────────────────────────────────────┘
            │
            ▼
        跳转到支付页面 / 调用支付 SDK
            │
            ▼
        用户完成支付
            │
            ▼
        支付回调
            │
            ▼
┌─────────────────────────────────────────┐
│           支付回调处理                   │
│                                         │
│ 1. 验证支付签名                         │
│ 2. 获取订单信息                         │
│ 3. 更新订单状态为 paid                 │
│ 4. 创建权限记录                         │
│ 5. 发送购买成功通知                     │
│ 6. 重新验证相关页面缓存                 │
└─────────────────────────────────────────┘
            │
            ▼
        ├── 支付成功 ────→ 显示成功页面，可安装
        │
        └── 支付失败 ────→ 显示失败提示，可重试
```

### 4.2 创建订单验证逻辑

```
创建订单请求
    │
    ▼
用户是否已登录？
    │
    ├── 否 ────→ 返回错误：请先登录
    │
    └── 是
            │
            ▼
        插件是否存在？
            │
            ├── 否 ────→ 返回错误：插件不存在
            │
            └── 是
                    │
                    ▼
                插件是否收费？
                    │
                    ├── 否 ────→ 返回错误：该插件为免费插件
                    │
                    └── 是
                            │
                            ▼
                        用户是否已购买（且未过期）？
                            │
                            ├── 是 ────→ 返回错误：您已购买此插件
                            │
                            └── 否 ────→ 继续创建订单
```

---

## 5. 支付集成设计

### 5.1 支付接口定义

**创建支付**

| 输入 | 类型 | 说明 |
|------|------|------|
| orderId | string | 订单 ID |
| amount | number | 支付金额（分）|
| description | string | 商品描述 |
| returnUrl | string | 支付完成后跳转 URL |

| 输出 | 类型 | 说明 |
|------|------|------|
| paymentId | string | 支付平台订单号 |
| paymentUrl | string | 支付页面 URL |

**支付回调**

| 输入 | 类型 | 说明 |
|------|------|------|
| orderId | string | 订单 ID |
| paymentId | string | 支付平台订单号 |
| status | string | 支付状态 |
| signature | string | 签名（用于验证）|

### 5.2 支持的支付方式

| 支付方式 | 说明 |
|----------|------|
| 微信支付 | 扫码支付、H5 支付 |
| 支付宝 | 扫码支付、H5 支付 |
| 企业内部支付 | 对接企业财务系统 |

---

## 6. 订阅续费设计

### 6.1 续费场景

| 场景 | 说明 |
|------|------|
| 手动续费 | 用户主动续费 |
| 到期提醒 | 到期前 7 天发送提醒 |
| 过期后续费 | 过期后仍可续费 |

### 6.2 续费流程

```
用户点击"续费"按钮
    │
    ▼
弹出续费对话框
┌─────────────────────────────────────────┐
│  续费订阅                                │
│                                         │
│  📦 插件名称                            │
│                                         │
│  当前状态：剩余 15 天 / 已过期           │
│                                         │
│  选择续费时长：                         │
│  ○ 续费 1 个月    ¥XX                  │
│  ● 续费 1 年      ¥XX  省 2 个月       │
│                                         │
│            [取消]  [确认续费]           │
└─────────────────────────────────────────┘
    │
    ▼
调用续费订单 Server Action
    │
    ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 查询现有购买记录                     │
│ 3. 验证是订阅模式（非一次性购买）       │
│ 4. 计算续费金额                         │
│ 5. 创建续费订单                         │
│ 6. 返回支付信息                         │
└─────────────────────────────────────────┘
    │
    ▼
后续支付流程同购买流程
```

### 6.3 续费后有效期计算

**情况 1：未过期时续费**

```
新到期时间 = 原到期时间 + 续费时长
```

**情况 2：已过期后续费**

```
新到期时间 = 当前时间 + 续费时长
```

---

## 7. 订阅到期处理

### 7.1 到期提醒

| 时间点 | 操作 |
|--------|------|
| 到期前 30 天 | 发送首次提醒 |
| 到期前 7 天 | 发送紧急提醒 |
| 到期前 1 天 | 发送最后提醒 |
| 到期当天 | 发送过期通知 |

### 7.2 过期后处理

| 状态 | 插件可用性 | 数据处理 |
|------|-----------|----------|
| 刚过期 | 不可用 | 保留安装状态和配置 |
| 过期 30 天内 | 不可用 | 保留数据，可续费恢复 |
| 过期超 30 天 | 不可用 | 可清理数据（可选）|

---

## 8. 购买状态查询

### 8.1 查询逻辑

```
查询用户对某插件的购买状态
    │
    ▼
查询权限记录
条件：userId + pluginId + grantType = 'purchase'
    │
    ├── 无记录 ────→ 返回：未购买
    │
    └── 有记录
            │
            ▼
        权限是否有过期时间？
            │
            ├── 否（expireAt = null）────→ 返回：永久购买
            │
            └── 是
                    │
                    ▼
                是否已过期？
                    │
                    ├── 是 ────→ 返回：订阅已过期
                    │
                    └── 否 ────→ 返回：订阅有效
                                  - 到期时间
                                  - 剩余天数
```

### 8.2 状态对应 UI

| 状态 | UI 显示 |
|------|---------|
| 未购买 | 显示"购买"按钮 + 价格 |
| 永久购买 | 显示"已购买"标记 + "安装"按钮 |
| 订阅有效 | 显示"剩余 X 天" + "安装"按钮 |
| 订阅即将到期 | 显示"⚠️ 即将到期" + "续费"按钮 |
| 订阅已过期 | 显示"已过期" + "续费"按钮 |

---

## 9. 退款设计（可选）

### 9.1 退款规则

| 购买类型 | 退款条件 | 退款金额 |
|----------|----------|----------|
| 一次性购买 | 购买后 7 天内且未使用 | 全额退款 |
| 订阅 | 当月内且未使用 | 剩余天数按比例退款 |

### 9.2 退款流程

```
用户申请退款
    │
    ▼
检查退款条件
    │
    ├── 不符合条件 ────→ 返回错误：不符合退款条件
    │
    └── 符合条件
            │
            ▼
        创建退款申请
            │
            ▼
        管理员审核
            │
            ├── 拒绝 ────→ 通知用户
            │
            └── 通过
                    │
                    ▼
                调用支付平台退款接口
                    │
                    ▼
                更新订单状态为 refunded
                    │
                    ▼
                删除权限记录
                    │
                    ▼
                通知用户退款成功
```

---

## 10. 购买记录展示

### 10.1 记录列表

位置：我的插件 → 购买记录 Tab

| 字段 | 说明 |
|------|------|
| 插件 | 图标 + 名称 |
| 购买类型 | 一次性购买 / 按月订阅 / 按年订阅 |
| 金额 | 支付金额 |
| 状态 | 永久有效 / 剩余 X 天 / 已过期 |
| 购买时间 | 订单支付时间 |
| 操作 | 安装 / 续费 |

### 10.2 订单详情

点击订单可查看详细信息：
- 订单号
- 支付方式
- 支付时间
- 发票信息（如有）
