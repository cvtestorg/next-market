# 认证与鉴权模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

认证与鉴权模块是整个插件市场系统的基础，负责：
- 用户登录状态管理
- 会话验证
- 路由保护
- 权限检查

---

## 2. 认证系统架构

### 2.1 系统组成

```
┌─────────────────────────────────────────────────────────────────┐
│                        Better Auth 认证系统                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │   服务端配置     │    │   客户端配置     │                    │
│  │   lib/auth.ts   │    │ lib/auth-client │                    │
│  └────────┬────────┘    └────────┬────────┘                    │
│           │                      │                              │
│           ▼                      ▼                              │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │ API 路由处理器   │    │  React Hooks    │                    │
│  │ /api/auth/*    │    │  useSession等   │                    │
│  └─────────────────┘    └─────────────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 配置项说明

**服务端配置（lib/auth.ts）**

| 配置项 | 说明 | 值 |
|--------|------|-----|
| database | 数据库适配器 | Prisma (PostgreSQL) |
| emailAndPassword.enabled | 启用邮箱密码登录 | true |
| session.expiresIn | 会话有效期 | 7 天 |
| session.updateAge | 会话更新间隔 | 1 天 |
| session.cookieCache.maxAge | Cookie 缓存时间 | 5 分钟 |
| user.additionalFields | 用户扩展字段 | role, orgId |
| plugins | 插件列表 | nextCookies() |

**用户扩展字段定义**

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| role | string | 否 | "user" | 用户角色 |
| orgId | string | 否 | null | 所属企业 ID |

**客户端配置（lib/auth-client.ts）**

| 配置项 | 说明 |
|--------|------|
| baseURL | 应用根 URL，用于 API 调用 |

---

## 3. 登录状态检查机制

### 3.1 三层检查架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     第一层：Proxy/Middleware                     │
│                                                                 │
│  职责：快速检查 Cookie 是否存在                                  │
│  特点：不验证有效性，仅做初筛                                    │
│  位置：请求进入应用前                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   第二层：Server Component                       │
│                                                                 │
│  职责：完整验证 Session 有效性                                   │
│  特点：验证 token 有效性、过期时间                               │
│  位置：页面组件渲染时                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   第三层：Client Component                       │
│                                                                 │
│  职责：交互时检查登录状态                                        │
│  特点：使用 useSession Hook 获取状态                            │
│  位置：用户执行操作前                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Proxy 层检查逻辑

**输入**
- 当前请求对象（包含 URL 和 Cookie）

**处理步骤**
1. 从请求中提取 Session Cookie
2. 获取当前请求路径
3. 判断路径是否属于受保护路径
4. 根据路径类型和 Cookie 状态决定处理方式

**路径分类**

| 路径类型 | 路径前缀 | 无 Cookie 时行为 |
|----------|----------|------------------|
| 受保护路径 | `/my-plugins`, `/developer`, `/admin` | 重定向到登录页 |
| 公开路径 | `/market`, `/sign-in`, `/sign-up` | 继续处理请求 |

**输出**
- 重定向响应（到登录页，携带 callbackUrl）
- 或继续处理请求

**流程图**

```
请求进入
    │
    ▼
提取 Session Cookie
    │
    ▼
获取请求路径
    │
    ▼
是否是受保护路径？ ──── 否 ────→ 继续处理请求
    │
    是
    │
    ▼
Cookie 是否存在？ ──── 是 ────→ 继续处理请求
    │
    否
    │
    ▼
重定向到登录页
(URL: /sign-in?callbackUrl=原路径)
```

### 3.3 Server Component 层验证逻辑

**输入**
- 当前请求的 headers（包含 Cookie）

**处理步骤**
1. 使用 headers() 获取请求头
2. 调用 auth.api.getSession() 验证会话
3. 根据验证结果决定渲染方式

**输出**
- Session 对象（包含用户信息）
- 或执行重定向

**流程图**

```
Server Component 开始渲染
    │
    ▼
获取请求 Headers
    │
    ▼
调用 auth.api.getSession()
验证 Session 有效性
    │
    ▼
Session 是否有效？ ──── 否 ────→ 重定向到登录页
    │
    是
    │
    ▼
提取用户信息
    │
    ▼
渲染页面内容
（传递用户信息给子组件）
```

### 3.4 Client Component 层检查逻辑

**输入**
- 无（使用 Hook 获取状态）

**处理步骤**
1. 调用 useSession() Hook
2. 根据返回状态处理 UI

**useSession 返回值**

| 字段 | 类型 | 说明 |
|------|------|------|
| data | Session \| null | 会话数据，未登录时为 null |
| isPending | boolean | 是否正在加载 |
| error | Error \| null | 错误信息 |

**UI 状态处理**

| isPending | data | UI 行为 |
|-----------|------|---------|
| true | - | 显示加载状态 |
| false | null | 显示未登录 UI（登录按钮或提示） |
| false | Session | 显示已登录 UI（操作按钮） |

---

## 4. 角色权限体系

### 4.1 角色定义

| 角色 | role 值 | 说明 |
|------|---------|------|
| 终端用户 | user | 普通已登录用户 |
| 开发者 | developer | 可上传插件的用户 |
| 企业管理员 | admin | 可管理企业的用户 |

### 4.2 角色层级

```
admin (企业管理员)
    │
    ├── 拥有 developer 的所有权限
    │
    ▼
developer (开发者)
    │
    ├── 拥有 user 的所有权限
    │
    ▼
user (终端用户)
    │
    └── 基础权限
```

### 4.3 权限检查函数设计

**hasRole(user, requiredRole)**
- 功能：检查用户是否具有指定角色或更高权限
- 输入：用户对象、所需角色
- 输出：布尔值
- 逻辑：比较用户角色层级与所需角色层级

**isDeveloper(user)**
- 功能：检查用户是否是开发者
- 输入：用户对象
- 输出：布尔值
- 逻辑：调用 hasRole(user, "developer")

**isAdmin(user)**
- 功能：检查用户是否是企业管理员
- 输入：用户对象
- 输出：布尔值
- 逻辑：调用 hasRole(user, "admin")

**belongsToOrg(user, orgId)**
- 功能：检查用户是否属于指定企业
- 输入：用户对象、企业 ID
- 输出：布尔值
- 逻辑：比较 user.orgId 与 orgId

**isOrgAdmin(user, orgId)**
- 功能：检查用户是否是指定企业的管理员
- 输入：用户对象、企业 ID
- 输出：布尔值
- 逻辑：isAdmin(user) && belongsToOrg(user, orgId)

---

## 5. 页面级权限检查设计

### 5.1 检查流程

```
页面组件渲染开始
    │
    ▼
获取 Session（调用 auth.api.getSession）
    │
    ▼
Session 是否存在？ ──── 否 ────→ 重定向到登录页
    │                            （携带 callbackUrl）
    是
    │
    ▼
调用权限检查函数
（如 isAdmin、isDeveloper）
    │
    ▼
权限是否满足？ ──── 否 ────→ 显示无权限页面组件
    │
    是
    │
    ▼
渲染正常页面内容
```

### 5.2 各页面权限要求

| 页面 | 路径 | 登录要求 | 角色要求 | 其他要求 |
|------|------|----------|----------|----------|
| 插件市场首页 | /market | 否 | 无 | - |
| 插件详情 | /market/plugin/[id] | 否 | 无 | - |
| 我的插件 | /my-plugins | 是 | user+ | - |
| 开发者中心 | /developer | 是 | developer+ | - |
| 企业管理 | /admin | 是 | admin | 需属于某企业 |

---

## 6. 布局设计

### 6.1 认证保护布局

**位置**：`app/(protected)/layout.tsx`

**职责**：
1. 验证用户已登录
2. 将用户信息注入 Context
3. 渲染认证后的公共 UI（Header、Footer）

**流程**：

```
布局组件渲染
    │
    ▼
获取 Session
    │
    ▼
Session 是否存在？ ──── 否 ────→ 重定向到 /sign-in
    │
    是
    │
    ▼
通过 UserProvider 注入用户信息
    │
    ▼
渲染子页面
```

### 6.2 公开页面布局

**位置**：`app/(public)/layout.tsx` 或根布局

**职责**：
1. 尝试获取用户信息（可选）
2. 将用户信息（可能为 null）注入 Context
3. 渲染公共 UI

**流程**：

```
布局组件渲染
    │
    ▼
尝试获取 Session
    │
    ▼
通过 UserProvider 注入用户信息
（如果未登录，注入 null）
    │
    ▼
渲染子页面
```

---

## 7. 登录页面设计

### 7.1 页面逻辑

**URL**：`/sign-in?callbackUrl=xxx`

**参数说明**

| 参数 | 类型 | 说明 |
|------|------|------|
| callbackUrl | string（可选） | 登录成功后跳转的目标页面 |

**页面加载流程**

```
页面加载
    │
    ▼
检查是否已登录
    │
    ▼
已登录？ ──── 是 ────→ 重定向到 callbackUrl 或 /market
    │
    否
    │
    ▼
显示登录表单
```

### 7.2 登录表单设计

**表单字段**

| 字段 | 类型 | 必填 | 验证规则 |
|------|------|------|----------|
| email | email | 是 | 有效的邮箱格式 |
| password | password | 是 | 非空 |

**提交流程**

```
用户点击登录按钮
    │
    ▼
显示加载状态
    │
    ▼
调用 signIn.email()
    │
    ▼
    ├── 登录失败 ────→ 显示错误提示
    │                  恢复按钮状态
    │
    └── 登录成功
            │
            ▼
        显示成功提示
            │
            ▼
        跳转到目标页面
            │
            ▼
        刷新页面状态
```

---

## 8. 登出设计

### 8.1 登出流程

```
用户点击登出按钮
    │
    ▼
显示加载状态
    │
    ▼
调用 signOut()
    │
    ▼
    ├── 登出失败 ────→ 显示错误提示
    │
    └── 登出成功
            │
            ▼
        显示成功提示
            │
            ▼
        跳转到 /market
            │
            ▼
        刷新页面状态
```

---

## 9. Server Action 认证设计

### 9.1 认证辅助函数设计

**requireAuth()**
- 功能：获取当前用户，未登录则抛出 AuthError
- 输入：无
- 输出：User 对象
- 异常：AuthError（未登录时）

**getOptionalUser()**
- 功能：获取当前用户（可选，不强制登录）
- 输入：无
- 输出：User | null

**requireDeveloper()**
- 功能：获取当前用户，要求开发者权限
- 输入：无
- 输出：User 对象
- 异常：AuthError（未登录）、PermissionError（非开发者）

**requireAdmin()**
- 功能：获取当前用户，要求管理员权限
- 输入：无
- 输出：User 对象
- 异常：AuthError（未登录）、PermissionError（非管理员）

### 9.2 Server Action 认证流程

```
Server Action 被调用
    │
    ▼
调用认证辅助函数
（requireAuth / requireDeveloper / requireAdmin）
    │
    ▼
    ├── 抛出 AuthError ────→ 返回 { success: false, error: "请先登录", needLogin: true }
    │
    ├── 抛出 PermissionError ────→ 返回 { success: false, error: "权限不足" }
    │
    └── 返回 User 对象
            │
            ▼
        执行业务逻辑
            │
            ▼
            ├── 业务异常 ────→ 返回 { success: false, error: "具体错误信息" }
            │
            └── 业务成功 ────→ 返回 { success: true, data: ... }
```

### 9.3 错误类型定义

| 错误类型 | 说明 | 默认消息 |
|----------|------|----------|
| AuthError | 认证错误，用户未登录 | "请先登录" |
| PermissionError | 权限错误，用户权限不足 | "权限不足" |

---

## 10. 用户上下文设计

### 10.1 UserProvider 设计

**职责**：
- 在组件树中共享用户信息
- 提供便捷的权限判断属性

**Context 值结构**

| 属性 | 类型 | 说明 |
|------|------|------|
| user | User \| null | 当前用户对象 |
| isAuthenticated | boolean | 是否已登录 |
| isAdmin | boolean | 是否是管理员 |
| isDeveloper | boolean | 是否是开发者 |

### 10.2 useUser Hook

**功能**：获取用户上下文

**返回值**：UserContextValue

**使用限制**：必须在 UserProvider 内部使用

---

## 11. 登录提示对话框设计

### 11.1 触发场景

| 场景 | 触发条件 |
|------|----------|
| 安装插件 | 未登录用户点击安装按钮 |
| 购买插件 | 未登录用户点击购买按钮 |
| 申请权限 | 未登录用户点击申请权限按钮 |
| 收藏插件 | 未登录用户点击收藏按钮 |

### 11.2 对话框内容

**标题**：需要登录

**描述**：请先登录后再执行此操作

**按钮**：
| 按钮 | 类型 | 动作 |
|------|------|------|
| 取消 | outline | 关闭对话框 |
| 去登录 | primary | 跳转到登录页（携带 callbackUrl） |

---

## 12. 安全设计原则

### 12.1 验证原则

| 原则 | 说明 |
|------|------|
| 服务端验证优先 | 永远不要仅依赖客户端检查，客户端代码可被绕过 |
| Server Action 必须验证 | 每个 Server Action 都要独立验证用户身份和权限 |
| Proxy 仅做初筛 | 完整验证在 Server Component 或 Server Action 中进行 |

### 12.2 数据安全

| 原则 | 说明 |
|------|------|
| 不暴露敏感信息 | 用户完整信息只在服务端使用 |
| 过滤传递数据 | 传递给客户端的数据只包含必要字段 |
| httpOnly Cookie | 会话 token 不在客户端 JS 中访问 |

### 12.3 CSRF 防护

- Better Auth 内置 CSRF 防护
- Server Actions 自动包含 CSRF token
- API 路由需要验证请求来源
