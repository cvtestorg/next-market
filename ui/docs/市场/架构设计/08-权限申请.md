# 权限申请模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

权限申请模块用于处理企业插件的使用权限申请流程，包括：
- 用户提交权限申请
- 权限申请状态查询
- 管理员审批处理
- 申请被拒绝后重新申请

---

## 2. 权限申请场景

### 2.1 需要申请权限的情况

| 插件类型 | 付费类型 | 是否需要申请 | 说明 |
|----------|----------|--------------|------|
| 官方插件 | 免费 | ❌ | 直接使用 |
| 官方插件 | 收费 | ❌ | 购买后使用 |
| 个人插件 | 免费 | ❌ | 直接使用 |
| 个人插件 | 收费 | ❌ | 购买后使用 |
| 企业插件 | 免费 | ✅ | 需要申请权限 |
| 企业插件 | 收费 | ✅ | 需要申请权限 + 购买 |

### 2.2 申请状态流转

```
┌─────────┐     提交申请     ┌─────────┐
│  未申请  │ ──────────────→ │  审核中  │
└─────────┘                  └────┬────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ↓             │             ↓
              ┌─────────┐        │       ┌─────────┐
              │  已通过  │        │       │  已拒绝  │
              └─────────┘        │       └────┬────┘
                                 │            │
                                 │       重新申请
                                 │            │
                                 └────────────┘
```

---

## 3. 权限申请数据模型

### 3.1 申请记录结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 申请记录 ID |
| userId | string | 申请人 ID |
| userName | string | 申请人名称 |
| userAvatar | string | 申请人头像 |
| pluginId | string | 目标插件 ID |
| pluginName | string | 插件名称 |
| pluginIcon | string | 插件图标 |
| reason | string | 申请理由 |
| status | enum | 状态：pending / approved / rejected |
| rejectReason | string | 拒绝原因（拒绝时填写）|
| reviewerId | string | 审核人 ID |
| createdAt | datetime | 申请时间 |
| reviewedAt | datetime | 审核时间 |

### 3.2 权限记录结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 权限记录 ID |
| userId | string | 用户 ID |
| pluginId | string | 插件 ID |
| grantType | enum | 授权方式：purchase / assign / approved |
| expireAt | datetime | 过期时间（订阅模式）|
| createdAt | datetime | 创建时间 |

---

## 4. 申请权限流程

### 4.1 提交申请流程

```
用户点击"申请使用权限"按钮
    │
    ▼
弹出申请对话框
┌─────────────────────────────────────────┐
│  申请使用权限                            │
│                                         │
│  ┌─────────────────────────────────────┐│
│  │ 📦 插件名称                         ││
│  │    作者名称                         ││
│  └─────────────────────────────────────┘│
│                                         │
│  申请理由 *                             │
│  ┌─────────────────────────────────────┐│
│  │                                     ││
│  │ 请详细说明您为什么需要使用此插件...  ││
│  │                                     ││
│  └─────────────────────────────────────┘│
│  至少 10 个字符                         │
│                                         │
│  ℹ️ 提交后，申请将发送给企业管理员审批    │
│                                         │
│            [取消]  [提交申请]           │
└─────────────────────────────────────────┘
    │
    ├── 取消 ────→ 关闭对话框
    │
    └── 提交
            │
            ▼
        表单验证
        （申请理由至少 10 个字符）
            │
            ├── 验证失败 ────→ 显示错误提示
            │
            └── 验证通过
                    │
                    ▼
                调用提交申请 Server Action
```

### 4.2 Server Action 处理流程

```
接收申请请求
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 验证用户已登录                        │
└─────────────────────────────────────────┘
    │
    ├── 未登录 ────→ 返回错误：请先登录
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 获取插件信息                          │
└─────────────────────────────────────────┘
    │
    ├── 插件不存在 ────→ 返回错误：插件不存在
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 验证是企业插件                        │
└─────────────────────────────────────────┘
    │
    ├── 不是企业插件 ────→ 返回错误：该插件无需申请权限
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 验证用户属于该企业                    │
└─────────────────────────────────────────┘
    │
    ├── 不属于 ────→ 返回错误：您无权访问此企业插件
    │
    ▼
┌─────────────────────────────────────────┐
│ 5. 检查是否已有权限                      │
└─────────────────────────────────────────┘
    │
    ├── 已有权限 ────→ 返回错误：您已拥有此插件的使用权限
    │
    ▼
┌─────────────────────────────────────────┐
│ 6. 检查是否有待审核的申请                │
└─────────────────────────────────────────┘
    │
    ├── 有待审核申请 ────→ 返回错误：您已有待审核的申请
    │
    ▼
┌─────────────────────────────────────────┐
│ 7. 创建申请记录                          │
│    状态设为 pending                      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 8. 发送通知给企业管理员（可选）          │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 9. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ▼
返回成功
```

---

## 5. 重新申请流程

### 5.1 触发条件

- 用户之前的申请被拒绝
- 用户想要修改申请理由重新提交

### 5.2 重新申请流程

```
用户点击"重新申请"按钮
    │
    ▼
弹出申请对话框
（预填原申请理由，显示上次拒绝原因）
┌─────────────────────────────────────────┐
│  重新申请使用权限                        │
│                                         │
│  ⚠️ 上次拒绝原因：                       │
│  "不符合使用条件"                        │
│                                         │
│  申请理由 *                             │
│  ┌─────────────────────────────────────┐│
│  │ [预填原申请理由]                     ││
│  └─────────────────────────────────────┘│
│                                         │
│            [取消]  [重新提交]           │
└─────────────────────────────────────────┘
    │
    ▼
后续流程同"提交申请"
```

---

## 6. 权限状态查询

### 6.1 查询逻辑

```
查询用户对某插件的权限状态
    │
    ▼
┌─────────────────────────────────────────┐
│ 查询有效权限记录                         │
│ 条件：userId + pluginId + 未过期        │
└─────────────────────────────────────────┘
    │
    ├── 存在有效权限
    │       │
    │       ▼
    │   返回：有权限
    │   - 权限类型（purchase/assign/approved）
    │   - 过期时间（如有）
    │
    └── 无有效权限
            │
            ▼
    ┌─────────────────────────────────────────┐
    │ 查询待审核的申请                         │
    │ 条件：userId + pluginId + status=pending│
    └─────────────────────────────────────────┘
            │
            ├── 存在待审核申请
            │       │
            │       ▼
            │   返回：等待审核
            │   - 申请记录信息
            │
            └── 无待审核申请
                    │
                    ▼
            ┌─────────────────────────────────────────┐
            │ 查询被拒绝的申请                         │
            │ 条件：userId + pluginId + status=rejected│
            │ 排序：最新优先                           │
            └─────────────────────────────────────────┘
                    │
                    ├── 存在被拒绝申请
                    │       │
                    │       ▼
                    │   返回：被拒绝（可重新申请）
                    │   - 拒绝原因
                    │   - 申请记录信息
                    │
                    └── 无申请记录
                            │
                            ▼
                        返回：无权限（可申请）
```

### 6.2 状态对应的 UI 显示

| 状态 | 操作卡片显示 |
|------|-------------|
| 有权限 | 根据价格显示"安装"或"购买"按钮 |
| 等待审核 | 显示"等待审批"（禁用状态）|
| 被拒绝 | 显示"重新申请"按钮 + 拒绝原因 |
| 无权限 | 显示"申请使用权限"按钮 |

---

## 7. 管理员审批设计

详细的管理员审批功能在 [11-企业管理.md](./11-企业管理.md) 中描述。

### 7.1 审批通过流程

```
管理员点击"通过"按钮
    │
    ▼
调用审批通过 Server Action
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 验证管理员身份                        │
│ 2. 验证管理员权限（属于该企业）          │
│ 3. 获取申请记录                          │
│ 4. 验证申请状态为 pending               │
│ 5. 事务处理：                            │
│    - 更新申请状态为 approved            │
│    - 创建权限记录                        │
│ 6. 发送通知给申请人（可选）              │
│ 7. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ▼
返回成功
```

### 7.2 审批拒绝流程

```
管理员点击"拒绝"按钮
    │
    ▼
弹出拒绝原因对话框
┌─────────────────────────────────────────┐
│  拒绝申请                                │
│                                         │
│  请填写拒绝「用户名」申请的原因          │
│                                         │
│  拒绝原因 *                             │
│  ┌─────────────────────────────────────┐│
│  │                                     ││
│  └─────────────────────────────────────┘│
│                                         │
│            [取消]  [确认拒绝]           │
└─────────────────────────────────────────┘
    │
    ▼
调用审批拒绝 Server Action
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 验证管理员身份                        │
│ 2. 验证管理员权限                        │
│ 3. 获取申请记录                          │
│ 4. 验证申请状态为 pending               │
│ 5. 更新申请状态为 rejected              │
│ 6. 记录拒绝原因                          │
│ 7. 发送通知给申请人（可选）              │
│ 8. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ▼
返回成功
```

---

## 8. 权限检查辅助逻辑

### 8.1 判断是否需要申请权限

**输入**：插件信息、用户信息

**判断逻辑**：

```
用户是否已登录？
    │
    ├── 否 ────→ 返回：否（未登录用户不能申请）
    │
    └── 是
            │
            ▼
        插件是否是企业插件？
            │
            ├── 否 ────→ 返回：否（非企业插件不需要申请）
            │
            └── 是
                    │
                    ▼
                用户是否属于该企业？
                    │
                    ├── 否 ────→ 返回：否（不属于该企业不能申请）
                    │
                    └── 是 ────→ 返回：是
```

### 8.2 判断是否可以安装

**输入**：用户 ID、插件信息

**判断逻辑**：

```
插件是否是免费非企业插件？
    │
    ├── 是 ────→ 返回：允许安装
    │
    └── 否
            │
            ▼
        插件是否收费？
            │
            ├── 是
            │       │
            │       ▼
            │   用户是否已购买？
            │       │
            │       ├── 否 ────→ 返回：需要先购买
            │       │
            │       └── 是 ────→ 继续检查
            │
            └── 否 ────→ 继续检查

继续检查：
    │
    ▼
插件是否是企业插件？
    │
    ├── 是
    │       │
    │       ▼
    │   用户是否有权限？
    │       │
    │       ├── 否 ────→ 返回：需要先申请权限
    │       │
    │       └── 是 ────→ 返回：允许安装
    │
    └── 否 ────→ 返回：允许安装
```

---

## 9. 通知机制

### 9.1 通知类型

| 事件 | 通知对象 | 通知内容 |
|------|----------|----------|
| 新权限申请 | 企业管理员 | 有新的插件权限申请待审批 |
| 申请通过 | 申请人 | 您的插件权限申请已通过 |
| 申请拒绝 | 申请人 | 您的插件权限申请被拒绝 |

### 9.2 通知方式

| 方式 | 说明 |
|------|------|
| 系统通知 | 站内消息通知 |
| 邮件通知 | 发送邮件（可选）|
| 推送通知 | 浏览器推送（可选）|
