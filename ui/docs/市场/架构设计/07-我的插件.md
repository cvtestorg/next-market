# 我的插件模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

我的插件页面是用户管理自己插件相关数据的中心，包括：
- 已安装的插件列表
- 权限申请记录
- 购买记录

---

## 2. 页面访问控制

### 2.1 访问要求

| 条件 | 处理方式 |
|------|----------|
| 未登录 | 重定向到登录页，callbackUrl = /my-plugins |
| 已登录 | 正常显示页面 |

### 2.2 访问检查流程

```
用户访问 /my-plugins
    │
    ▼
获取 Session
    │
    ▼
Session 是否存在？
    │
    ├── 否 ────→ 重定向到 /sign-in?callbackUrl=/my-plugins
    │
    └── 是 ────→ 正常渲染页面
```

---

## 3. 页面结构设计

### 3.1 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│  页面头部                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 标题：我的插件                                               ││
│  │ 描述：管理您安装的插件和申请记录                              ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  统计卡片区域                                                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                          │
│  │ 已安装  │ │ 待审核  │ │ 已购买  │                          │
│  │   12   │ │    2   │ │    5   │                          │
│  └─────────┘ └─────────┘ └─────────┘                          │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  [已安装插件] [权限申请] [购买记录]                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Tab 内容区域                                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 组件层级

```
MyPluginsPage (Server Component)
├── PageHeader
├── StatsCards
└── Tabs
    ├── InstalledPluginsTab (Client Component)
    ├── PermissionRequestsTab (Client Component)
    └── PurchaseRecordsTab (Client Component)
```

---

## 4. 数据获取设计

### 4.1 页面数据需求

| 数据 | 说明 |
|------|------|
| 已安装插件列表 | 用户安装的所有插件及其状态 |
| 权限申请列表 | 用户提交的权限申请记录 |
| 购买记录列表 | 用户的插件购买/订阅记录 |
| 统计数据 | 各类数据的数量统计 |

### 4.2 数据获取流程

```
页面加载
    │
    ▼
验证用户登录状态（已在前面检查）
    │
    ▼
并行获取数据 (Promise.all)
    │
    ├── 获取已安装插件列表
    │
    ├── 获取权限申请列表
    │
    └── 获取购买记录列表
    │
    ▼
计算统计数据
    │
    ▼
渲染页面组件
```

---

## 5. 已安装插件 Tab 设计

### 5.1 列表结构

```
┌─────────────────────────────────────────────────────────────────┐
│  ┌─────────────────────────┐ ┌─────────────────────────────────┐│
│  │ 🔍 搜索已安装插件...     │ │[批量启动] [批量停止] [批量卸载]  ││
│  └─────────────────────────┘ └─────────────────────────────────┘│
├─────────────────────────────────────────────────────────────────┤
│  □ │ 插件 │ 版本 │ 状态 │ 安装时间 │ 操作                       │
├─────────────────────────────────────────────────────────────────┤
│  □ │ 📦 插件1 │ v1.2.0 │ ● 运行中 │ 2024-01-01 │ [停止] [更多]│
│  □ │ 📦 插件2 │ v2.0.0 │ ○ 已停止 │ 2024-01-02 │ [启动] [更多]│
│  □ │ 📦 插件3 │ v1.0.0 │ ● 运行中 │ 2024-01-03 │ [停止] [更多]│
│    │         │ 有新版本 v1.1.0 可用                            │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 列表字段说明

| 字段 | 说明 |
|------|------|
| 选择框 | 用于批量操作 |
| 插件 | 图标 + 名称，点击跳转详情 |
| 版本 | 当前安装版本，有新版本时显示提示 |
| 状态 | 运行中（绿色）/ 已停止（灰色）|
| 安装时间 | 安装日期 |
| 操作 | 启动/停止、更多操作下拉菜单 |

### 5.3 更多操作菜单

| 操作 | 说明 |
|------|------|
| 查看详情 | 跳转到插件详情页 |
| 配置 | 跳转到插件详情页的配置 Tab |
| 更新 | 如果有新版本，显示此选项 |
| 卸载 | 卸载此插件 |

### 5.4 批量操作

| 操作 | 条件 | 说明 |
|------|------|------|
| 批量启动 | 选中包含已停止的插件 | 启动所有选中的已停止插件 |
| 批量停止 | 选中包含运行中的插件 | 停止所有选中的运行中插件 |
| 批量卸载 | 选中至少一个插件 | 卸载所有选中的插件 |

### 5.5 搜索功能

- 搜索范围：插件名称
- 即时筛选，无需提交

---

## 6. 权限申请 Tab 设计

### 6.1 列表结构

```
┌─────────────────────────────────────────────────────────────────┐
│  状态筛选：[全部] [待审核] [已通过] [已拒绝]                       │
├─────────────────────────────────────────────────────────────────┤
│  插件 │ 申请理由 │ 状态 │ 申请时间 │ 操作                        │
├─────────────────────────────────────────────────────────────────┤
│  📦 插件1 │ 工作需要... │ 🟡 待审核 │ 2024-01-01 │ [查看]       │
│  📦 插件2 │ 项目需求... │ 🟢 已通过 │ 2024-01-02 │ [安装]       │
│  📦 插件3 │ 测试使用... │ 🔴 已拒绝 │ 2024-01-03 │ [重新申请]   │
│           │ 拒绝原因：xxx                                       │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 状态说明

| 状态 | 图标 | 颜色 | 可用操作 |
|------|------|------|----------|
| pending | 🟡 | 黄色 | 查看详情 |
| approved | 🟢 | 绿色 | 安装插件（如未安装）|
| rejected | 🔴 | 红色 | 重新申请 |

### 6.3 已拒绝申请处理

- 显示拒绝原因
- 提供"重新申请"按钮
- 点击后弹出申请对话框，预填原申请理由

---

## 7. 购买记录 Tab 设计

### 7.1 列表结构

```
┌─────────────────────────────────────────────────────────────────┐
│  类型筛选：[全部] [一次性] [订阅中] [已过期]                       │
├─────────────────────────────────────────────────────────────────┤
│  插件 │ 购买类型 │ 金额 │ 状态 │ 购买时间 │ 操作                 │
├─────────────────────────────────────────────────────────────────┤
│  📦 插件1 │ 一次性购买 │ ¥99 │ 永久有效 │ 2024-01-01 │ [安装]   │
│  📦 插件2 │ 按月订阅 │ ¥19/月 │ 剩余 15 天 │ 2024-01-02 │ [续费]│
│  📦 插件3 │ 按年订阅 │ ¥199/年 │ 已过期 │ 2023-01-03 │ [续费]  │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 购买类型说明

| 类型 | 说明 | 状态显示 |
|------|------|----------|
| 一次性购买 | 永久有效 | "永久有效" |
| 按月订阅 | 每月续费 | "剩余 X 天" 或 "已过期" |
| 按年订阅 | 每年续费 | "剩余 X 天" 或 "已过期" |

### 7.3 订阅状态

| 状态 | 显示 | 操作 |
|------|------|------|
| 有效期 > 30 天 | 剩余 X 天 | 续费 |
| 有效期 ≤ 30 天 | ⚠️ 即将到期，剩余 X 天 | 续费（高亮）|
| 已过期 | 已过期 | 续费 |

---

## 8. 空状态设计

### 8.1 无已安装插件

```
┌─────────────────────────────────────────┐
│                                         │
│              📦                         │
│                                         │
│        您还没有安装任何插件              │
│                                         │
│           [去市场看看]                  │
│                                         │
└─────────────────────────────────────────┘
```

### 8.2 无权限申请记录

```
┌─────────────────────────────────────────┐
│                                         │
│              📋                         │
│                                         │
│        暂无权限申请记录                  │
│                                         │
└─────────────────────────────────────────┘
```

### 8.3 无购买记录

```
┌─────────────────────────────────────────┐
│                                         │
│              💰                         │
│                                         │
│        暂无购买记录                      │
│                                         │
│     [浏览付费插件]                       │
│                                         │
└─────────────────────────────────────────┘
```

---

## 9. 交互设计

### 9.1 操作确认

| 操作 | 需要确认 | 确认内容 |
|------|----------|----------|
| 单个停止 | 是 | 确定要停止「插件名」吗？ |
| 单个卸载 | 是 | 确定要卸载「插件名」吗？卸载后个人配置将被清除。 |
| 批量停止 | 是 | 确定要停止以下 N 个插件吗？ |
| 批量卸载 | 是 | 确定要卸载以下 N 个插件吗？ |

### 9.2 操作反馈

| 操作 | 成功提示 | 失败提示 |
|------|----------|----------|
| 启动 | 「插件名」已启动 | 启动失败：{原因} |
| 停止 | 「插件名」已停止 | 停止失败：{原因} |
| 卸载 | 「插件名」已卸载 | 卸载失败：{原因} |
| 批量操作 | 成功 N 个，失败 M 个 | 全部失败：{原因} |

### 9.3 乐观更新

| 操作 | 乐观更新行为 |
|------|-------------|
| 启动 | 立即显示"运行中"状态 |
| 停止 | 立即显示"已停止"状态 |
| 卸载 | 立即从列表移除 |

---

## 10. 数据刷新策略

### 10.1 自动刷新场景

| 场景 | 刷新方式 |
|------|----------|
| 完成安装操作 | revalidatePath |
| 完成卸载操作 | revalidatePath |
| 完成启动/停止操作 | revalidatePath |
| 权限申请状态变化 | revalidatePath |

### 10.2 手动刷新

提供刷新按钮，用户可手动刷新数据
