# 企业管理模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

企业管理页面是企业管理员管理企业插件和权限的中心，包括：
- 权限申请审批
- 局域插件管理
- 权限分配
- 企业配置管理

---

## 2. 页面访问控制

### 2.1 访问要求

| 条件 | 处理方式 |
|------|----------|
| 未登录 | 重定向到登录页 |
| 已登录但非管理员 | 显示无权限页面 |
| 已登录且是管理员 | 正常显示页面 |

### 2.2 访问检查流程

```
用户访问 /admin
    │
    ▼
获取 Session
    │
    ├── 未登录 ────→ 重定向到 /sign-in?callbackUrl=/admin
    │
    └── 已登录
            │
            ▼
        用户角色是否为 admin？
            │
            ├── 否 ────→ 显示无权限页面
            │            "此页面仅限企业管理员访问"
            │
            └── 是 ────→ 正常渲染页面
```

---

## 3. 页面结构设计

### 3.1 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│  页面头部                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 🏢 企业管理                                                 ││
│  │ 管理局域插件、审批权限申请、配置企业参数                      ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  统计卡片区域                                                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│  │ 待审核  │ │ 已通过  │ │ 已拒绝  │ │ 局域插件 │              │
│  │    5   │ │   23   │ │    3   │ │    8   │              │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  [权限审批] [局域插件]                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Tab 内容区域                                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 组件层级

```
AdminPage (Server Component)
├── PageHeader
├── StatsCards
└── Tabs
    ├── PermissionRequestsTab (Client Component)
    └── EnterprisePluginsTab (Client Component)
```

---

## 4. 权限审批 Tab 设计

### 4.1 列表结构

```
┌─────────────────────────────────────────────────────────────────┐
│  状态筛选：[全部] [待审核] [已通过] [已拒绝]                       │
│  搜索：┌───────────────────────────┐                            │
│        │ 🔍 搜索用户或插件...        │                            │
│        └───────────────────────────┘                            │
├─────────────────────────────────────────────────────────────────┤
│  申请人 │ 申请插件 │ 申请理由 │ 状态 │ 申请时间 │ 操作           │
├─────────────────────────────────────────────────────────────────┤
│  👤张三 │ 📦插件1 │ 工作需要... │ 🟡待审核 │ 01-01 │ [通过][拒绝]│
│  👤李四 │ 📦插件2 │ 项目需求... │ 🟢已通过 │ 01-02 │ [查看]      │
│  👤王五 │ 📦插件3 │ 测试使用... │ 🔴已拒绝 │ 01-03 │ [查看]      │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 列表字段说明

| 字段 | 说明 |
|------|------|
| 申请人 | 头像 + 姓名 |
| 申请插件 | 图标 + 插件名称 |
| 申请理由 | 截断显示，完整理由在详情中 |
| 状态 | 待审核/已通过/已拒绝 |
| 申请时间 | 提交申请的时间 |
| 操作 | 通过/拒绝（待审核）或 查看（已处理）|

### 4.3 审批通过流程

```
管理员点击"通过"按钮
    │
    ▼
执行乐观更新
（立即显示"已通过"状态）
    │
    ▼
调用审批通过 Server Action
    │
    ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证管理员身份                        │
│ 2. 验证管理员权限（属于该企业）          │
│ 3. 获取申请记录                          │
│ 4. 验证申请状态为 pending               │
│ 5. 事务处理：                            │
│    - 更新申请状态为 approved            │
│    - 记录审核人和审核时间                │
│    - 创建权限记录                        │
│ 6. 发送通知给申请人                      │
│ 7. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

### 4.4 审批拒绝流程

```
管理员点击"拒绝"按钮
    │
    ▼
弹出拒绝原因对话框
┌─────────────────────────────────────────┐
│  拒绝申请                                │
│                                         │
│  请填写拒绝「张三」申请的原因            │
│                                         │
│  拒绝原因 *                             │
│  ┌─────────────────────────────────────┐│
│  │                                     ││
│  └─────────────────────────────────────┘│
│                                         │
│            [取消]  [确认拒绝]           │
└─────────────────────────────────────────┘
    │
    ├── 取消 ────→ 关闭对话框
    │
    └── 确认
            │
            ▼
        执行乐观更新
            │
            ▼
        调用审批拒绝 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证管理员身份                        │
│ 2. 验证管理员权限                        │
│ 3. 获取申请记录                          │
│ 4. 验证申请状态为 pending               │
│ 5. 更新申请状态为 rejected              │
│ 6. 记录拒绝原因、审核人、审核时间        │
│ 7. 发送通知给申请人                      │
│ 8. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

---

## 5. 局域插件 Tab 设计

### 5.1 列表结构

```
┌─────────────────────────────────────────────────────────────────┐
│  插件 │ 版本 │ 价格 │ 下载量 │ 状态 │ 操作                       │
├─────────────────────────────────────────────────────────────────┤
│  📦 插件1 │ v1.2.0 │ 免费 │ 234 │ 🟢已上架 │ [更多▼]            │
│  📦 插件2 │ v2.0.0 │ 免费 │ 123 │ 🟢已上架 │ [更多▼]            │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 操作菜单

| 操作 | 说明 |
|------|------|
| 查看详情 | 跳转到插件详情页 |
| 分配权限 | 批量为用户分配使用权限 |
| 企业配置 | 配置企业级参数 |

---

## 6. 权限分配功能

### 6.1 分配权限对话框

```
┌─────────────────────────────────────────┐
│  分配权限                                │
│                                         │
│  为「插件名」分配用户使用权限            │
│                                         │
│  ┌─────────────────────────────────────┐│
│  │ 📦 插件名称                         ││
│  │    作者名称                         ││
│  └─────────────────────────────────────┘│
│                                         │
│  搜索用户：                             │
│  ┌─────────────────────────────────────┐│
│  │ 🔍 搜索用户...                       ││
│  └─────────────────────────────────────┘│
│                                         │
│  用户列表：                             │
│  ┌─────────────────────────────────────┐│
│  │ ☑ 张三 - 产品部                     ││
│  │ ☑ 李四 - 技术部                     ││
│  │ ☐ 王五 - 市场部                     ││
│  │ ...                                 ││
│  └─────────────────────────────────────┘│
│                                         │
│            [取消]  [确认分配 (2)]       │
└─────────────────────────────────────────┘
```

### 6.2 分配流程

```
管理员选择用户并点击"确认分配"
    │
    ▼
调用权限分配 Server Action
    │
    ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证管理员身份                        │
│ 2. 验证插件归属本企业                    │
│ 3. 批量创建权限记录                      │
│    - grantType = 'assign'              │
│    - 如果已存在则跳过                    │
│ 4. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 显示成功提示
    │              "已为 N 名用户分配权限"
    │
    └── 失败 ────→ 显示错误提示
```

---

## 7. 企业配置功能

### 7.1 企业配置对话框

```
┌─────────────────────────────────────────┐
│  企业配置                                │
│                                         │
│  配置「插件名」的企业级参数              │
│                                         │
│  API 地址 *                             │
│  ┌─────────────────────────────────────┐│
│  │ https://api.example.com             ││
│  └─────────────────────────────────────┘│
│  插件将使用此地址进行数据请求            │
│                                         │
│  API 密钥 *                             │
│  ┌─────────────────────────────────────┐│
│  │ ••••••••••••                        ││
│  └─────────────────────────────────────┘│
│  用于 API 认证                          │
│                                         │
│  启用功能 A                             │
│  [开关 ●]                               │
│  启用后将开放高级功能                    │
│                                         │
│            [取消]  [保存配置]           │
└─────────────────────────────────────────┘
```

### 7.2 配置保存流程

```
管理员修改配置并点击"保存配置"
    │
    ▼
客户端验证
（检查必填项、格式验证）
    │
    ├── 验证失败 ────→ 显示错误提示
    │
    └── 验证通过
            │
            ▼
        调用保存配置 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证管理员身份                        │
│ 2. 验证插件归属本企业                    │
│ 3. 验证配置值                            │
│ 4. 处理敏感数据加密（password 类型）     │
│ 5. 保存/更新配置记录                     │
│ 6. 重新验证相关页面缓存                  │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 显示成功提示
    │              "企业配置保存成功"
    │
    └── 失败 ────→ 显示错误提示
```

---

## 8. 数据获取设计

### 8.1 页面数据需求

| 数据 | 说明 |
|------|------|
| 权限申请列表 | 本企业所有插件的权限申请 |
| 局域插件列表 | 本企业的企业插件 |
| 统计数据 | 待审核、已通过、已拒绝数量 |

### 8.2 数据获取流程

```
页面加载
    │
    ▼
获取 Session（获取 orgId）
    │
    ▼
并行获取数据 (Promise.all)
    │
    ├── 获取权限申请列表
    │   条件：申请的插件属于本企业
    │
    ├── 获取局域插件列表
    │   条件：orgId = 本企业，sourceType = enterprise
    │
    └── 获取统计数据
        │
        ▼
    渲染页面组件
```

---

## 9. 空状态设计

### 9.1 无待审批申请

```
┌─────────────────────────────────────────┐
│                                         │
│              ✅                         │
│                                         │
│        暂无待审批的权限申请              │
│                                         │
│        所有申请已处理完毕                │
│                                         │
└─────────────────────────────────────────┘
```

### 9.2 无局域插件

```
┌─────────────────────────────────────────┐
│                                         │
│              📦                         │
│                                         │
│        暂无局域插件                      │
│                                         │
│  联系管理员上传企业内部插件              │
│                                         │
└─────────────────────────────────────────┘
```

---

## 10. 搜索和筛选

### 10.1 权限申请筛选

| 筛选项 | 说明 |
|--------|------|
| 状态筛选 | 全部/待审核/已通过/已拒绝 |
| 关键词搜索 | 搜索申请人姓名或插件名称 |

### 10.2 筛选逻辑

- 筛选条件变化时，即时更新列表
- 筛选状态保存在组件内部（不同步到 URL）
- 默认显示"待审核"状态

---

## 11. 通知设计

### 11.1 审批结果通知

| 事件 | 通知对象 | 通知内容 |
|------|----------|----------|
| 审批通过 | 申请人 | 您申请使用「插件名」的请求已通过 |
| 审批拒绝 | 申请人 | 您申请使用「插件名」的请求被拒绝：{原因} |

### 11.2 通知方式

- 站内消息通知
- 邮件通知（可选）
