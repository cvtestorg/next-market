# 插件市场首页模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

插件市场首页是用户浏览和发现插件的主入口，负责：
- 展示插件列表
- 提供搜索筛选功能
- 显示统计信息
- 处理未登录用户场景

---

## 2. 页面结构设计

### 2.1 整体布局

```
┌─────────────────────────────────────────────────────────────────┐
│  页面头部                                                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 标题：插件市场                                               ││
│  │ 描述：发现和安装适合你的插件                                  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  统计卡片区域                                                    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│  │ 全部插件 │ │ 已安装  │ │  官方   │ │  企业   │              │
│  │   128   │ │   12   │ │   45   │ │   32   │              │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  搜索筛选区域                                                    │
│  ┌──────────────────────────────────────┐ ┌──────┐ ┌──────┐  │
│  │ 🔍 搜索插件...                        │ │ 来源 │ │ 价格 │  │
│  └──────────────────────────────────────┘ └──────┘ └──────┘  │
│  ┌──────────┐ ┌──────────┐                                    │
│  │ 分类筛选  │ │ 排序方式  │                                    │
│  └──────────┘ └──────────┘                                    │
│  已选筛选条件: [官方] [免费] [×]                                 │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  插件列表区域                                                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │  插件卡片 1  │ │  插件卡片 2  │ │  插件卡片 3  │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │  插件卡片 4  │ │  插件卡片 5  │ │  插件卡片 6  │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────────┐
│  分页区域                                                        │
│                    < 1 2 3 ... 10 >                              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 组件层级

```
MarketPage (Server Component)
├── PageHeader
├── StatsCards (Server Component)
├── SearchFilterSection (Client Component)
│   ├── SearchInput
│   ├── SourceFilter
│   ├── PriceFilter
│   ├── CategoryFilter
│   ├── SortSelect
│   └── ActiveFilters
├── PluginGrid (Server Component)
│   └── PluginCard × N
└── Pagination (Client Component)
```

---

## 3. 数据获取设计

### 3.1 页面数据需求

| 数据 | 来源 | 是否需要登录 | 说明 |
|------|------|-------------|------|
| 插件列表 | 数据库 | 否 | 根据筛选条件获取 |
| 统计信息 | 数据库 | 否 | 各类插件数量 |
| 用户已安装列表 | 数据库 | 是 | 用于标记已安装状态 |
| 当前用户信息 | Session | 是 | 用于判断操作权限 |

### 3.2 数据获取流程

```
页面加载
    │
    ▼
┌─────────────────────────────────────────┐
│ 解析 URL 搜索参数                        │
│ (keyword, source, price, category, etc) │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 获取 Session（可选）                     │
│ 用户未登录时 user = null                 │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 并行获取数据 (Promise.all)              │
│                                         │
│ ┌─────────────┐ ┌─────────────┐        │
│ │ 获取插件列表 │ │ 获取统计信息 │        │
│ └─────────────┘ └─────────────┘        │
│ ┌─────────────────────────────┐        │
│ │ 获取用户已安装列表（如已登录）│        │
│ └─────────────────────────────┘        │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 渲染页面组件                             │
│ 传递数据给各子组件                       │
└─────────────────────────────────────────┘
```

### 3.3 插件列表查询参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| keyword | string | "" | 搜索关键词 |
| sourceType | "all" \| "official" \| "personal" \| "enterprise" | "all" | 来源筛选 |
| priceType | "all" \| "free" \| "paid" | "all" | 价格筛选 |
| category | string | "all" | 分类筛选 |
| sortBy | "downloads" \| "rating" \| "createdAt" \| "updatedAt" | "downloads" | 排序字段 |
| sortOrder | "asc" \| "desc" | "desc" | 排序方向 |
| page | number | 1 | 当前页码 |
| pageSize | number | 12 | 每页数量 |

---

## 4. 统计卡片设计

### 4.1 统计项定义

| 统计项 | 图标 | 说明 | 用户状态影响 |
|--------|------|------|-------------|
| 全部插件 | Package | 市场中所有可见插件数量 | 无 |
| 已安装 | Download | 当前用户已安装的插件数量 | 未登录显示 "-" |
| 官方插件 | Building2 | 官方来源的插件数量 | 无 |
| 企业插件 | Shield | 本企业的内部插件数量 | 未登录或无企业显示 "-" |

### 4.2 未登录用户处理

```
渲染统计卡片
    │
    ▼
用户是否已登录？
    │
    ├── 否 ────→ "已安装"显示 "-"
    │            "企业插件"显示 "-"
    │
    └── 是
            │
            ▼
        用户是否属于企业？
            │
            ├── 否 ────→ "企业插件"显示 "-"
            │
            └── 是 ────→ 正常显示所有数据
```

---

## 5. 插件卡片设计

### 5.1 卡片信息结构

```
┌─────────────────────────────────────────┐
│  ┌────┐                        [来源标签]│
│  │图标│  插件名称                       │
│  └────┘  作者名称                       │
│                                         │
│  插件简介描述文字...                     │
│                                         │
│  ┌───────┐ ┌───────┐ ┌───────┐        │
│  │ 下载量 │ │  评分  │ │  版本  │        │
│  └───────┘ └───────┘ └───────┘        │
│                                         │
│  [价格/免费]              [状态/操作按钮]│
└─────────────────────────────────────────┘
```

### 5.2 卡片状态显示

| 用户状态 | 插件状态 | 显示内容 |
|----------|----------|----------|
| 未登录 | - | 显示"登录后安装"或跳转链接 |
| 已登录 | 未安装 | 显示"安装"或"购买"按钮 |
| 已登录 | 已安装 | 显示"已安装"标记和运行状态 |
| 已登录 | 需要权限 | 显示"申请权限"按钮 |
| 已登录 | 权限待审核 | 显示"审核中"状态 |

### 5.3 来源标签样式

| 来源类型 | 标签文字 | 颜色 |
|----------|----------|------|
| official | 官方 | 蓝色 |
| personal | 个人 | 紫色 |
| enterprise | 企业 | 青色 |

---

## 6. 未登录用户处理设计

### 6.1 可见内容

| 内容 | 可见性 | 说明 |
|------|--------|------|
| 插件列表 | ✅ 可见 | 可浏览所有公开插件 |
| 插件详情入口 | ✅ 可见 | 可点击进入详情页 |
| 统计信息 | 部分可见 | 个人相关数据显示 "-" |
| 搜索筛选 | ✅ 可见 | 功能完整可用 |

### 6.2 操作限制

| 操作 | 未登录行为 |
|------|-----------|
| 点击安装 | 弹出登录提示对话框 |
| 点击购买 | 弹出登录提示对话框 |
| 点击申请权限 | 弹出登录提示对话框 |

### 6.3 登录提示对话框

**触发条件**：未登录用户尝试执行需要登录的操作

**对话框内容**：
- 标题：需要登录
- 描述：请先登录后再执行此操作
- 按钮：取消 / 去登录

**登录跳转**：携带当前页面 URL 作为 callbackUrl

---

## 7. 空状态处理

### 7.1 无搜索结果

```
┌─────────────────────────────────────────┐
│                                         │
│              🔍                         │
│                                         │
│        未找到匹配的插件                  │
│                                         │
│   试试其他关键词或清除筛选条件            │
│                                         │
│           [清除筛选条件]                 │
│                                         │
└─────────────────────────────────────────┘
```

### 7.2 无插件数据

```
┌─────────────────────────────────────────┐
│                                         │
│              📦                         │
│                                         │
│          暂无可用插件                    │
│                                         │
│       稍后再来看看吧                     │
│                                         │
└─────────────────────────────────────────┘
```

---

## 8. 加载状态设计

### 8.1 页面级加载

使用 `loading.tsx` 展示骨架屏

```
┌─────────────────────────────────────────┐
│  ████████████████                       │
│  ██████████                             │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐          │
│  │████│ │████│ │████│ │████│          │
│  └────┘ └────┘ └────┘ └────┘          │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│  ┌─────────────┐ ┌─────────────┐        │
│  │█████████████│ │█████████████│        │
│  │█████████    │ │█████████    │        │
│  │█████████████│ │█████████████│        │
│  └─────────────┘ └─────────────┘        │
│  ...                                    │
└─────────────────────────────────────────┘
```

### 8.2 筛选切换加载

筛选条件变化时，插件列表区域显示加载指示器，其他区域保持不变

---

## 9. 响应式设计

### 9.1 断点定义

| 断点 | 宽度 | 每行卡片数 |
|------|------|-----------|
| sm | < 640px | 1 |
| md | 640-768px | 2 |
| lg | 768-1024px | 3 |
| xl | > 1024px | 4 |

### 9.2 移动端适配

- 搜索框全宽显示
- 筛选条件折叠到下拉菜单
- 卡片单列显示
- 分页使用简化版本

---

## 10. 性能优化设计

### 10.1 优化策略

| 策略 | 说明 |
|------|------|
| 并行数据获取 | 使用 Promise.all 同时获取多个数据源 |
| 服务端渲染 | 首屏数据在服务端获取，减少客户端请求 |
| 图片懒加载 | 使用 next/image 自动优化 |
| 分页加载 | 避免一次加载过多数据 |
| URL 状态同步 | 筛选状态保存在 URL，支持分享和刷新 |

### 10.2 缓存策略

| 数据 | 缓存方式 | 过期时间 |
|------|----------|----------|
| 插件列表 | 服务端缓存 | 1 分钟 |
| 统计信息 | 服务端缓存 | 5 分钟 |
| 分类列表 | 静态数据 | 不过期 |
