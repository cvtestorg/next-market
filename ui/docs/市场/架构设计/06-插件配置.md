# 插件配置模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

插件配置模块负责管理插件的配置参数，包括：
- 配置项定义（Schema）
- 企业级配置
- 个人级配置
- 配置值获取与保存

---

## 2. 配置层级设计

### 2.1 配置层级

```
┌─────────────────────────────────────────┐
│            默认配置（Default）           │
│        插件开发者定义的默认值            │
└─────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────┐
│           企业配置（Enterprise）         │
│        企业管理员为本企业设置的值         │
└─────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────┐
│            个人配置（Personal）          │
│          用户为自己设置的值              │
└─────────────────────────────────────────┘
```

### 2.2 配置优先级

**读取配置时的优先级**（从高到低）：

| 优先级 | 配置来源 | 说明 |
|--------|----------|------|
| 1（最高） | 个人配置 | 用户自己设置的值 |
| 2 | 企业配置 | 企业管理员设置的值 |
| 3（最低） | 默认配置 | 插件定义的默认值 |

**获取有效配置值逻辑**：

```
获取配置项的有效值
    │
    ▼
个人配置中是否存在该项？
    │
    ├── 是 ────→ 返回个人配置值
    │
    └── 否
            │
            ▼
        企业配置中是否存在该项？
            │
            ├── 是 ────→ 返回企业配置值
            │
            └── 否 ────→ 返回默认配置值
```

---

## 3. 配置项类型定义

### 3.1 支持的配置项类型

| 类型 | type 值 | 说明 | UI 组件 |
|------|---------|------|---------|
| 文本 | text | 单行文本输入 | Input |
| 密码 | password | 密码输入（加密存储）| Password Input |
| 数字 | number | 数字输入 | Number Input |
| 布尔 | boolean | 是/否开关 | Switch |
| 单选 | select | 单选下拉框 | Select |
| 多选 | multiselect | 多选 | Multi-select |
| 日期 | date | 日期选择 | Date Picker |
| 时间 | time | 时间选择 | Time Picker |

### 3.2 配置项 Schema 结构

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | 是 | 配置项唯一标识 |
| pluginId | string | 是 | 所属插件 ID |
| key | string | 是 | 配置项键名（用于读取）|
| name | string | 是 | 配置项显示名称 |
| description | string | 否 | 配置项说明 |
| type | enum | 是 | 配置项类型 |
| defaultValue | string | 否 | 默认值 |
| configType | enum | 是 | 配置级别：enterprise / personal |
| required | boolean | 否 | 是否必填 |
| options | json | 否 | 选项列表（select/multiselect 类型）|
| example | string | 否 | 示例值 |
| validation | json | 否 | 验证规则 |
| order | number | 否 | 显示顺序 |

### 3.3 选项格式（options）

```
[
  { "label": "选项1显示文字", "value": "option1" },
  { "label": "选项2显示文字", "value": "option2" },
  { "label": "选项3显示文字", "value": "option3" }
]
```

### 3.4 验证规则格式（validation）

| 规则 | 适用类型 | 说明 |
|------|----------|------|
| minLength | text, password | 最小长度 |
| maxLength | text, password | 最大长度 |
| min | number | 最小值 |
| max | number | 最大值 |
| pattern | text | 正则表达式 |
| message | 所有 | 验证失败提示 |

示例：
```
{
  "minLength": 6,
  "maxLength": 100,
  "pattern": "^https?://",
  "message": "请输入有效的 URL"
}
```

---

## 4. 配置表单设计

### 4.1 配置页面结构

```
┌─────────────────────────────────────────┐
│  [企业配置] [个人配置]                   │
├─────────────────────────────────────────┤
│                                         │
│  配置项名称 1                           │
│  ┌─────────────────────────────────────┐│
│  │ 输入框/选择器/开关                   ││
│  └─────────────────────────────────────┘│
│  配置项说明文字                         │
│                                         │
│  配置项名称 2 *                         │
│  ┌─────────────────────────────────────┐│
│  │ 输入框/选择器/开关                   ││
│  └─────────────────────────────────────┘│
│  配置项说明文字                         │
│                                         │
│  ... 更多配置项 ...                     │
│                                         │
│                              [保存配置] │
└─────────────────────────────────────────┘
```

### 4.2 Tab 切换逻辑

| 当前 Tab | 显示内容 | 可编辑条件 |
|----------|----------|-----------|
| 企业配置 | configType = "enterprise" 的配置项 | 用户是企业管理员 |
| 个人配置 | configType = "personal" 的配置项 | 用户已安装此插件 |

### 4.3 配置项 UI 组件映射

| 类型 | UI 组件 | 特殊处理 |
|------|---------|----------|
| text | Input | placeholder 显示 example |
| password | Input type="password" | 显示/隐藏按钮 |
| number | Input type="number" | min/max 限制 |
| boolean | Switch | - |
| select | Select | options 作为选项 |
| multiselect | Multi-select | 多选支持 |
| date | DatePicker | 日期格式化 |
| time | TimePicker | 时间格式化 |

---

## 5. 配置值存储设计

### 5.1 企业配置存储

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 记录 ID |
| pluginId | string | 插件 ID |
| orgId | string | 企业 ID |
| key | string | 配置项键名 |
| value | string | 配置值（加密存储敏感数据）|
| updatedAt | datetime | 更新时间 |
| updatedBy | string | 更新人 ID |

### 5.2 个人配置存储

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 记录 ID |
| pluginId | string | 插件 ID |
| userId | string | 用户 ID |
| key | string | 配置项键名 |
| value | string | 配置值（加密存储敏感数据）|
| updatedAt | datetime | 更新时间 |

---

## 6. 敏感数据处理

### 6.1 需要加密的数据类型

| 配置类型 | 加密要求 |
|----------|----------|
| password | 必须加密存储 |
| text（含敏感标记）| 必须加密存储 |
| 其他类型 | 明文存储 |

### 6.2 加密流程

**保存配置时**：

```
接收配置值
    │
    ▼
配置项类型是否为 password？
    │
    ├── 是 ────→ 使用加密算法加密值
    │            存储加密后的值
    │
    └── 否 ────→ 直接存储明文值
```

**读取配置时**：

```
读取存储的配置值
    │
    ▼
配置项类型是否为 password？
    │
    ├── 是 ────→ 使用解密算法解密值
    │            返回明文值给业务使用
    │            UI 显示为掩码
    │
    └── 否 ────→ 直接返回值
```

### 6.3 加密算法要求

| 要求 | 说明 |
|------|------|
| 算法 | AES-256-CBC 或更强 |
| 密钥管理 | 使用环境变量存储密钥 |
| IV | 每次加密使用随机 IV |
| 格式 | 存储格式：IV:加密数据（Base64）|

---

## 7. 配置保存流程

### 7.1 保存流程

```
用户修改配置并点击保存
    │
    ▼
┌─────────────────────────────────────────┐
│              客户端验证                  │
│ 1. 检查必填项是否填写                    │
│ 2. 检查格式是否符合验证规则              │
└─────────────────────────────────────────┘
    │
    ├── 验证失败 ────→ 显示错误提示，标记错误字段
    │
    └── 验证通过
            │
            ▼
        调用保存配置 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 验证操作权限                         │
│    - 企业配置需要管理员权限             │
│    - 个人配置需要已安装插件             │
│ 3. 验证配置值                           │
│ 4. 处理敏感数据加密                     │
│ 5. 保存/更新配置记录                    │
│ 6. 重新验证相关页面缓存                 │
│ 7. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 显示成功提示
    │
    └── 失败 ────→ 显示错误提示
```

### 7.2 权限检查

**企业配置保存**：
- 用户必须已登录
- 用户必须是企业管理员
- 用户必须属于该插件所在企业（企业插件）

**个人配置保存**：
- 用户必须已登录
- 用户必须已安装该插件

---

## 8. 配置值获取流程

### 8.1 获取有效配置

```
请求获取插件配置
    │
    ▼
获取配置 Schema 列表
    │
    ▼
┌─────────────────────────────────────────┐
│ 对每个配置项，按优先级获取有效值         │
│                                         │
│ 1. 查询个人配置表                       │
│ 2. 如果无个人配置，查询企业配置表        │
│ 3. 如果无企业配置，使用默认值            │
└─────────────────────────────────────────┘
    │
    ▼
返回配置键值对
```

### 8.2 返回数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| key | string | 配置项键名 |
| value | any | 有效配置值 |
| source | enum | 值来源：personal / enterprise / default |
| editable | boolean | 当前用户是否可编辑 |

---

## 9. 配置表单状态设计

### 9.1 表单状态

| 状态 | 说明 | UI 表现 |
|------|------|---------|
| 初始 | 加载完成，显示当前值 | 正常显示 |
| 编辑中 | 用户修改了配置 | 保存按钮高亮 |
| 保存中 | 正在提交保存 | 保存按钮 loading |
| 保存成功 | 保存完成 | 显示成功提示 |
| 保存失败 | 保存出错 | 显示错误提示 |

### 9.2 未保存提示

当用户修改了配置但未保存，尝试离开页面时：

```
┌─────────────────────────────────────────┐
│  您有未保存的更改                        │
│                                         │
│  确定要离开吗？未保存的更改将丢失。       │
│                                         │
│         [取消]  [不保存并离开]           │
└─────────────────────────────────────────┘
```

---

## 10. 只读模式设计

### 10.1 只读场景

| 场景 | 说明 |
|------|------|
| 查看企业配置（非管理员）| 普通用户只能查看，不能编辑 |
| 查看其他人的配置 | 管理员查看用户配置时 |

### 10.2 只读模式 UI

- 所有输入控件显示为禁用状态
- 隐藏保存按钮
- 显示提示文字："您只有查看权限，无法编辑此配置"
