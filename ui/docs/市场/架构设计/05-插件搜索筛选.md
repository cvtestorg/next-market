# 插件搜索筛选模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

插件搜索筛选模块负责帮助用户快速找到所需插件，包括：
- 关键词搜索
- 多维度筛选
- 排序功能
- 筛选状态管理

---

## 2. 筛选参数设计

### 2.1 URL 参数定义

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| keyword | string | "" | 搜索关键词 |
| source | string | "all" | 来源筛选 |
| price | string | "all" | 价格筛选 |
| category | string | "all" | 分类筛选 |
| sortBy | string | "downloads" | 排序字段 |
| sortOrder | string | "desc" | 排序方向 |
| page | number | 1 | 当前页码 |

### 2.2 来源筛选选项

| 值 | 显示文字 | 说明 |
|-----|----------|------|
| all | 全部来源 | 不筛选来源 |
| official | 官方插件 | 平台官方开发 |
| personal | 个人插件 | 个人开发者上传 |
| enterprise | 企业插件 | 企业内部插件（需权限）|

### 2.3 价格筛选选项

| 值 | 显示文字 | 说明 |
|-----|----------|------|
| all | 全部价格 | 不筛选价格 |
| free | 免费 | 免费插件 |
| paid | 付费 | 需要购买的插件 |

### 2.4 分类筛选选项

| 值 | 显示文字 |
|-----|----------|
| all | 全部分类 |
| efficiency | 效率工具 |
| development | 开发工具 |
| data | 数据处理 |
| ai | AI 能力 |
| communication | 沟通协作 |
| other | 其他 |

### 2.5 排序选项

| sortBy 值 | sortOrder 值 | 显示文字 |
|-----------|-------------|----------|
| downloads | desc | 下载量最高 |
| rating | desc | 评分最高 |
| createdAt | desc | 最新发布 |
| updatedAt | desc | 最近更新 |
| name | asc | 名称 A-Z |

---

## 3. 搜索筛选区域设计

### 3.1 组件结构

```
SearchFilterSection
├── SearchInput（搜索框）
├── FilterSelects（筛选下拉框组）
│   ├── SourceFilter
│   ├── PriceFilter
│   └── CategoryFilter
├── SortSelect（排序下拉框）
└── ActiveFilters（已选筛选条件标签）
```

### 3.2 布局设计

```
┌─────────────────────────────────────────────────────────────────┐
│  ┌───────────────────────────────────────┐ ┌────┐ ┌────┐ ┌────┐│
│  │ 🔍 搜索插件名称、描述、作者...         │ │来源│ │价格│ │分类││
│  └───────────────────────────────────────┘ └────┘ └────┘ └────┘│
│                                                                 │
│  排序：[下载量最高 ▼]                                           │
│                                                                 │
│  已选：[官方 ×] [免费 ×] [效率工具 ×]           [清除全部筛选]    │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 移动端布局

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────────┐│
│  │ 🔍 搜索插件...                   ││
│  └─────────────────────────────────┘│
│                                     │
│  [筛选 ▼]  [排序 ▼]                │
│                                     │
│  已选：[官方 ×] [免费 ×]            │
└─────────────────────────────────────┘
```

---

## 4. 搜索功能设计

### 4.1 搜索字段

搜索关键词将匹配以下字段：
- 插件名称（name）
- 插件描述（description）
- 作者名称（author.name）
- 标签（tags）

### 4.2 搜索逻辑

**匹配规则**：包含匹配（LIKE '%keyword%'）

**多关键词处理**：空格分隔，AND 关系

示例："AI 工具" 匹配：名称或描述同时包含"AI"和"工具"的插件

### 4.3 防抖处理

**目的**：避免用户输入过程中频繁请求

**实现方式**：
- 防抖延迟：300ms
- 用户停止输入 300ms 后才触发搜索

**流程图**：

```
用户输入字符
    │
    ▼
重置防抖计时器
    │
    ▼
等待 300ms
    │
    ▼
300ms 内是否有新输入？
    │
    ├── 是 ────→ 回到"重置防抖计时器"
    │
    └── 否 ────→ 执行搜索
                  更新 URL 参数
                  触发数据刷新
```

---

## 5. URL 状态同步设计

### 5.1 设计目标

- 筛选状态保存在 URL 中
- 支持分享 URL 给他人
- 刷新页面保持筛选状态
- 浏览器前进/后退正常工作

### 5.2 状态同步流程

**筛选条件变化时**：

```
用户修改筛选条件
    │
    ▼
构建新的 URL 参数
    │
    ▼
是否是非默认值？
    │
    ├── 是 ────→ 将参数添加到 URL
    │
    └── 否 ────→ 从 URL 中删除该参数
            │
            ▼
        如果不是翻页操作，重置页码为 1
            │
            ▼
        调用 router.push() 更新 URL
            │
            ▼
        Server Component 重新渲染
        （自动获取新数据）
```

**页面加载时**：

```
页面加载
    │
    ▼
从 URL 解析 searchParams
    │
    ▼
将参数传递给 SearchFilterSection
作为 initialFilters
    │
    ▼
组件根据 initialFilters 设置初始状态
```

### 5.3 参数处理规则

| 情况 | 处理方式 |
|------|----------|
| 参数值为默认值 | 从 URL 中删除 |
| 参数值为空字符串 | 从 URL 中删除 |
| 参数值为 "all" | 从 URL 中删除 |
| 参数值为有效非默认值 | 保留在 URL 中 |

---

## 6. 服务端查询构建设计

### 6.1 查询条件构建

**基础条件**：
- 插件状态为"已上架"（status = 'approved'）
- 企业插件需要用户属于该企业

**筛选条件映射**：

| 参数 | 数据库字段 | 查询方式 |
|------|-----------|----------|
| keyword | name, description | LIKE（模糊匹配）|
| source | sourceType | = （精确匹配）|
| price | priceType | = （精确匹配）|
| category | category | CONTAINS（数组包含）|

### 6.2 排序条件构建

| sortBy | sortOrder | 数据库排序 |
|--------|-----------|-----------|
| downloads | desc | downloadCount DESC |
| rating | desc | rating DESC |
| createdAt | desc | createdAt DESC |
| updatedAt | desc | updatedAt DESC |
| name | asc | name ASC |

**次要排序**：所有排序都添加 `id DESC` 作为次要排序，确保结果稳定

### 6.3 分页查询

| 参数 | 计算方式 |
|------|----------|
| skip | (page - 1) * pageSize |
| take | pageSize（默认 12）|

---

## 7. 搜索建议功能（可选）

### 7.1 功能说明

用户输入时，显示搜索建议列表

### 7.2 建议来源

| 类型 | 来源 | 优先级 |
|------|------|--------|
| 热门插件 | 下载量 Top N | 高 |
| 匹配插件名 | 名称包含关键词 | 中 |
| 匹配作者 | 作者名包含关键词 | 低 |

### 7.3 交互设计

```
用户输入 "AI"
    │
    ▼
┌─────────────────────────────────────┐
│ 🔍 AI                               │
├─────────────────────────────────────┤
│  插件                               │
│  ├─ AI 助手                         │
│  ├─ AI 写作工具                     │
│  └─ AI 图像生成                     │
│                                     │
│  作者                               │
│  └─ AI Labs                         │
└─────────────────────────────────────┘
```

---

## 8. 已选筛选条件显示设计

### 8.1 显示规则

- 只显示非默认值的筛选条件
- 每个条件显示为可点击的标签
- 点击标签的 × 可移除该条件
- 有多个条件时显示"清除全部"按钮

### 8.2 标签设计

```
[标签文字 ×]

示例：
[官方 ×] [免费 ×] [效率工具 ×]  [清除全部筛选]
```

### 8.3 交互

| 操作 | 结果 |
|------|------|
| 点击标签 × | 移除该筛选条件，重新搜索 |
| 点击"清除全部筛选" | 移除所有筛选条件，重置为默认 |

---

## 9. 分页设计

### 9.1 分页信息

| 数据 | 说明 |
|------|------|
| total | 符合条件的总数量 |
| page | 当前页码 |
| pageSize | 每页数量 |
| totalPages | 总页数 = ceil(total / pageSize) |

### 9.2 分页组件设计

**完整模式（桌面端）**：

```
共 128 条结果

< 1 2 3 ... 8 9 10 >

  │ │ │     │ │ │
  │ │ │     │ │ └─ 最后一页
  │ │ │     │ └─── 倒数第二页
  │ │ │     └───── 省略号
  │ │ └─────────── 第三页
  │ └───────────── 第二页
  └─────────────── 第一页
```

**简化模式（移动端）**：

```
< 第 3 页，共 10 页 >
```

### 9.3 分页规则

| 场景 | 显示规则 |
|------|----------|
| 总页数 ≤ 7 | 显示所有页码 |
| 当前页靠近开头 | 1 2 3 4 5 ... N |
| 当前页靠近结尾 | 1 ... N-4 N-3 N-2 N-1 N |
| 当前页在中间 | 1 ... P-1 P P+1 ... N |

---

## 10. 空结果处理

### 10.1 无搜索结果

**显示内容**：

```
┌─────────────────────────────────────────┐
│                                         │
│              🔍                         │
│                                         │
│        未找到匹配的插件                  │
│                                         │
│   关键词："AI 图像"                     │
│   筛选条件：官方、免费                   │
│                                         │
│   建议：                                │
│   • 尝试使用更少的关键词                │
│   • 清除部分筛选条件                    │
│   • 检查是否有拼写错误                  │
│                                         │
│        [清除筛选条件]                   │
│                                         │
└─────────────────────────────────────────┘
```

### 10.2 无数据（首次加载）

**显示内容**：

```
┌─────────────────────────────────────────┐
│                                         │
│              📦                         │
│                                         │
│          暂无可用插件                    │
│                                         │
│       稍后再来看看吧                     │
│                                         │
└─────────────────────────────────────────┘
```

---

## 11. 加载状态设计

### 11.1 搜索/筛选切换时

**行为**：
- 搜索框和筛选器保持可用
- 插件列表区域显示加载指示器
- 分页区域暂时隐藏

**加载指示器**：
- 使用半透明遮罩 + 加载动画
- 或使用骨架屏替代当前列表

### 11.2 首次加载时

**行为**：
- 使用 loading.tsx 显示完整骨架屏
- 所有区域都显示加载占位符
