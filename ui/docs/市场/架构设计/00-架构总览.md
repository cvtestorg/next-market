# 插件市场架构设计总览

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 系统架构概述

### 1.1 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端框架 | Next.js (App Router) | 使用 Server Components 优先，减少客户端 JS 体积 |
| UI 组件库 | shadcn/ui + Tailwind CSS | 可定制的组件库，统一设计风格 |
| 状态管理 | React Hooks + Context | 轻量级状态管理，按需使用 |
| 认证方案 | Better Auth | 支持多种认证方式，类型安全 |
| 数据获取 | Server Components + Server Actions | 服务端数据获取，减少客户端请求 |
| 表单验证 | Zod + React Hook Form | 类型安全的表单验证 |

### 1.2 目录结构

```
app/
├── (auth)/                    # 认证相关页面组
│   ├── sign-in/page.tsx       # 登录页面
│   └── sign-up/page.tsx       # 注册页面
│
├── (protected)/               # 需要认证的页面组
│   ├── layout.tsx             # 认证保护布局
│   ├── market/                # 插件市场
│   │   ├── page.tsx           # 市场首页
│   │   └── plugin/[id]/page.tsx
│   ├── my-plugins/page.tsx    # 我的插件
│   ├── developer/page.tsx     # 开发者中心
│   └── admin/page.tsx         # 企业管理
│
├── api/auth/[...all]/route.ts # Better Auth API 路由
└── layout.tsx                 # 根布局

components/
├── ui/                        # shadcn/ui 组件
├── market/                    # 市场相关组件
└── shared/                    # 共享组件

lib/
├── auth.ts                    # Better Auth 服务端配置
├── auth-client.ts             # Better Auth 客户端配置
└── db.ts                      # 数据库连接

types/                         # 类型定义
hooks/                         # 自定义 Hooks
```

---

## 2. 核心模块划分

### 2.1 模块依赖关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                         认证与鉴权模块                           │
│                    (所有受保护功能的基础)                         │
└─────────────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                           权限检查层                             │
│              (判断用户角色、插件权限、操作权限)                   │
└─────────────────────────────────────────────────────────────────┘
                                ▼
        ┌───────────────┬───────────────┬───────────────┐
        ▼               ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│  插件市场模块  │ │  我的插件模块  │ │ 开发者中心模块 │ │  企业管理模块  │
│  (浏览/搜索)  │ │ (已安装管理)  │ │  (插件上传)   │ │  (权限审批)   │
└───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘
        │               │               │               │
        └───────────────┴───────────────┴───────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         插件操作层                               │
│        (安装/卸载/启动/停止/更新/购买/配置/权限申请)              │
└─────────────────────────────────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                           数据层                                 │
│              (插件数据/用户数据/配置数据/权限数据)                │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 模块索引

| 模块 | 文档 | 说明 |
|------|------|------|
| 认证与鉴权 | [01-认证与鉴权.md](./01-认证与鉴权.md) | 用户登录状态检查、会话管理、路由保护 |
| 插件市场首页 | [02-插件市场首页.md](./02-插件市场首页.md) | 插件列表展示、搜索筛选、统计信息 |
| 插件详情 | [03-插件详情.md](./03-插件详情.md) | 插件信息展示、版本历史、配置管理 |
| 插件操作 | [04-插件操作.md](./04-插件操作.md) | 安装/卸载/启动/停止/更新操作逻辑 |
| 插件搜索筛选 | [05-插件搜索筛选.md](./05-插件搜索筛选.md) | 关键词搜索、分类筛选、排序 |
| 插件配置 | [06-插件配置.md](./06-插件配置.md) | 企业配置、个人配置、配置项类型 |
| 我的插件 | [07-我的插件.md](./07-我的插件.md) | 已安装列表、权限申请记录、购买记录 |
| 权限申请 | [08-权限申请.md](./08-权限申请.md) | 权限申请流程、状态流转 |
| 收费插件与购买 | [09-收费插件与购买.md](./09-收费插件与购买.md) | 购买流程、订阅管理 |
| 开发者中心 | [10-开发者中心.md](./10-开发者中心.md) | 插件上传、版本管理、价格设置 |
| 企业管理 | [11-企业管理.md](./11-企业管理.md) | 权限审批、局域插件管理、企业配置 |
| Tauri 桌面端适配 | [12-Tauri桌面端适配.md](./12-Tauri桌面端适配.md) | 桌面应用打包兼容性设计 |

---

## 3. 用户角色与访问控制

### 3.1 角色定义

| 角色 | 说明 | 权限范围 |
|------|------|----------|
| 未登录用户 | 未进行身份认证的访客 | 仅可浏览公开市场，需登录后才能操作 |
| 终端用户 | 普通已登录用户 | 浏览市场、安装插件、管理已安装插件 |
| 开发者 | 具有开发者身份的用户 | 终端用户权限 + 上传插件、版本管理 |
| 企业管理员 | 企业的管理人员 | 终端用户权限 + 权限审批、企业配置 |

### 3.2 页面访问权限矩阵

| 页面 | 未登录 | 终端用户 | 开发者 | 企业管理员 |
|------|--------|----------|--------|------------|
| 插件市场首页 | ✅ (只读) | ✅ | ✅ | ✅ |
| 插件详情页 | ✅ (只读) | ✅ | ✅ | ✅ |
| 我的插件 | ❌ → 登录页 | ✅ | ✅ | ✅ |
| 开发者中心 | ❌ → 登录页 | ❌ → 申请开发者 | ✅ | ✅ |
| 企业管理 | ❌ → 登录页 | ❌ → 无权限提示 | ❌ → 无权限提示 | ✅ |

### 3.3 操作权限矩阵

| 操作 | 未登录 | 终端用户 | 开发者 | 企业管理员 |
|------|--------|----------|--------|------------|
| 浏览插件 | ✅ | ✅ | ✅ | ✅ |
| 安装免费插件 | ❌ | ✅ | ✅ | ✅ |
| 购买收费插件 | ❌ | ✅ | ✅ | ✅ |
| 申请企业插件权限 | ❌ | ✅ (本企业) | ✅ (本企业) | ✅ (本企业) |
| 上传插件 | ❌ | ❌ | ✅ | ✅ |
| 审批权限申请 | ❌ | ❌ | ❌ | ✅ |
| 管理企业配置 | ❌ | ❌ | ❌ | ✅ |

---

## 4. 认证流程设计

### 4.1 页面加载认证检查流程

```
用户访问页面
    │
    ▼
┌─────────────────────────────┐
│    第一层：Proxy/Middleware │
│    检查 Cookie 是否存在      │
└─────────────────────────────┘
    │
    ├── Cookie 不存在 ──────────────────────────────┐
    │                                               │
    │                                               ▼
    │                               ┌────────────────────────────┐
    │                               │   判断页面类型              │
    │                               └────────────────────────────┘
    │                                       │
    │                       ┌───────────────┴───────────────┐
    │                       │                               │
    │                       ▼                               ▼
    │               受保护页面                         公开页面
    │                   │                               │
    │                   ▼                               ▼
    │           重定向到登录页               继续加载（只读模式）
    │           (携带 callbackUrl)
    │
    └── Cookie 存在
            │
            ▼
    ┌─────────────────────────────┐
    │  第二层：Server Component   │
    │  完整验证 Session 有效性     │
    └─────────────────────────────┘
            │
            ├── Session 无效 ─────→ 清除 Cookie，重定向到登录页
            │
            └── Session 有效
                    │
                    ▼
            ┌─────────────────────────────┐
            │  第三层：角色权限检查        │
            │  检查用户是否有权访问当前页面 │
            └─────────────────────────────┘
                    │
                    ├── 无权限 ─────→ 显示无权限提示页面
                    │
                    └── 有权限 ─────→ 正常渲染页面
```

### 4.2 操作权限检查流程

```
用户点击操作按钮（如：安装插件）
    │
    ▼
┌─────────────────────────────┐
│    客户端检查登录状态        │
│    (useSession Hook)        │
└─────────────────────────────┘
    │
    ├── 未登录 ─────────────────────────────────────┐
    │                                               │
    │                                               ▼
    │                                       弹出登录提示对话框
    │                                       询问是否跳转登录
    │
    └── 已登录
            │
            ▼
    ┌─────────────────────────────┐
    │    调用 Server Action       │
    └─────────────────────────────┘
            │
            ▼
    ┌─────────────────────────────┐
    │    服务端验证 Session       │
    │    验证用户身份             │
    └─────────────────────────────┘
            │
            ├── 验证失败 ─────→ 返回错误（需要重新登录）
            │
            └── 验证成功
                    │
                    ▼
            ┌─────────────────────────────┐
            │    检查操作权限             │
            │    (角色、插件权限等)       │
            └─────────────────────────────┘
                    │
                    ├── 权限不足 ─────→ 返回权限不足错误
                    │
                    └── 权限通过
                            │
                            ▼
                    ┌─────────────────────────────┐
                    │    执行业务逻辑             │
                    │    返回操作结果             │
                    └─────────────────────────────┘
```

---

## 5. 数据流设计

### 5.1 服务端渲染数据流

```
┌─────────────────────────────────────────────────────────────────┐
│                      Server Component                           │
│                                                                 │
│  步骤 1: 获取认证信息（调用 auth.api.getSession）               │
│  步骤 2: 根据用户身份获取业务数据（数据库查询）                  │
│  步骤 3: 将数据传递给子组件（props 或 Context）                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Client Component                           │
│                                                                 │
│  步骤 1: 接收服务端传递的初始数据                               │
│  步骤 2: 处理用户交互（点击、输入等）                           │
│  步骤 3: 调用 Server Action 执行操作                            │
│  步骤 4: 根据结果更新 UI（乐观更新或重新验证）                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 客户端操作数据流（乐观更新模式）

```
用户点击操作按钮
    │
    ▼
┌───────────────────────────────────┐
│    乐观更新 (Optimistic Update)   │
│    立即更新 UI 状态，提供即时反馈  │
└───────────────────────────────────┘
    │
    ▼ (同时)
┌───────────────────────────────────┐
│         Server Action             │
│    1. 验证请求合法性              │
│    2. 执行数据库操作              │
│    3. 返回操作结果                │
└───────────────────────────────────┘
    │
    ├── 操作成功 ─────→ 确认乐观更新，显示成功提示
    │
    └── 操作失败 ─────→ 回滚乐观更新，显示错误提示
```

---

## 6. 错误处理策略

### 6.1 错误分类与处理方式

| 错误类型 | 触发条件 | 处理方式 | 用户提示 |
|----------|----------|----------|----------|
| 未登录 | Session 不存在或无效 | 重定向到登录页 | "请先登录" |
| 无权限 | 用户角色不满足要求 | 显示无权限页面 | "您没有权限访问此页面" |
| 数据不存在 | 查询的资源不存在 | 显示 404 页面 | "插件不存在" |
| 网络错误 | 请求超时或网络断开 | 显示重试按钮 | "网络错误，请重试" |
| 服务器错误 | 服务端抛出异常 | 显示错误边界 | "服务暂时不可用" |
| 业务逻辑错误 | 业务规则不满足 | Toast 提示 | 具体错误信息 |

### 6.2 错误边界层级

```
app/
├── error.tsx              # 全局错误边界（兜底）
├── not-found.tsx          # 全局 404 页面
└── (protected)/
    ├── error.tsx          # 受保护页面错误边界
    └── market/
        ├── error.tsx      # 市场模块错误边界
        └── plugin/[id]/
            └── not-found.tsx  # 插件不存在页面
```

---

## 7. 设计原则与规范

### 7.1 Server Components 优先原则

| 场景 | 使用 Server Component | 使用 Client Component |
|------|----------------------|----------------------|
| 数据展示 | ✅ | - |
| 表单交互 | - | ✅ |
| 状态管理 | - | ✅ |
| 事件处理 | - | ✅ |
| 静态内容 | ✅ | - |

### 7.2 数据获取原则

| 原则 | 说明 |
|------|------|
| 服务端获取优先 | 在 Server Components 中直接获取数据 |
| 避免瀑布流请求 | 使用 Promise.all 并行获取多个数据源 |
| 适当缓存 | 对不常变化的数据使用缓存策略 |
| 错误处理 | 始终处理数据获取可能的错误 |

### 7.3 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 组件文件 | kebab-case | `plugin-card.tsx` |
| 组件名称 | PascalCase | `PluginCard` |
| 函数/变量 | camelCase | `handleInstall` |
| 常量 | UPPER_SNAKE_CASE | `MAX_PAGE_SIZE` |
| 类型定义 | PascalCase | `Plugin`, `UserPermission` |
| API 路由 | kebab-case | `/api/plugins/:id/install` |

---

## 8. 运行模式与 Tauri 兼容性

### 8.1 运行模式说明

本架构设计主要针对 **Web 模式**，即通过浏览器访问的场景。

| 模式 | 说明 | 数据获取 | 认证方式 |
|------|------|----------|----------|
| Web 模式 | 浏览器访问 | Server Components | Cookie/Session |
| Desktop 模式 | Tauri 桌面应用 | 客户端 Hooks | Token-based |

### 8.2 当前设计的 Tauri 兼容性

⚠️ **当前设计针对 Web 模式优化，如需支持 Tauri 打包需要额外适配**

| 设计要素 | Tauri 兼容性 | 说明 |
|----------|-------------|------|
| Server Components | 🔴 不兼容 | 静态导出不支持 |
| Server Actions | 🔴 不兼容 | 静态导出不支持 |
| Better Auth Cookie | 🟡 需适配 | 需改为 Token 认证 |
| API Routes | 🔴 不兼容 | 需使用外部 API |
| URL 状态同步 | 🟢 兼容 | 客户端实现 |
| 乐观更新 | 🟢 兼容 | 客户端实现 |

### 8.3 Tauri 适配方案概述

如需支持 Tauri 桌面应用，参考 [12-Tauri桌面端适配.md](./12-Tauri桌面端适配.md) 进行以下改造：

1. **组件分层**：将展示组件与数据获取逻辑分离
2. **认证抽象**：支持 Cookie 和 Token 两种认证方式
3. **数据获取抽象**：支持 SSR 和客户端 Hook 两种方式
4. **后端 API 完善**：Go 后端实现完整认证 API

### 8.4 推荐策略

| 场景 | 建议 |
|------|------|
| 仅 Web 版本 | 保持现有设计，无需修改 |
| 计划支持 Desktop | 开发时注意组件分层，预留适配空间 |
| 同时支持两端 | 实现双模式架构，详见适配文档 |
