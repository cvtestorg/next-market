# 插件操作模块设计

## 文档版本
- 版本：2.0
- 更新日期：2026-01-12

---

## 1. 模块概述

插件操作模块负责处理用户对插件的各种操作，包括：
- 安装插件
- 卸载插件
- 启动插件
- 停止插件
- 更新插件

---

## 2. 操作权限矩阵

| 操作 | 未登录 | 无权限用户 | 有权限用户 | 已安装用户 |
|------|--------|-----------|-----------|-----------|
| 安装 | ❌ | ❌ | ✅ | ❌（已安装）|
| 卸载 | ❌ | ❌ | ❌ | ✅ |
| 启动 | ❌ | ❌ | ❌ | ✅ |
| 停止 | ❌ | ❌ | ❌ | ✅ |
| 更新 | ❌ | ❌ | ❌ | ✅ |

---

## 3. 安装插件

### 3.1 安装流程

```
用户点击"安装"按钮
    │
    ▼
┌─────────────────────────────────────────┐
│              客户端检查                  │
│ 1. 检查用户是否已登录                    │
│ 2. 检查按钮是否在加载中（防重复点击）     │
└─────────────────────────────────────────┘
    │
    ├── 未登录 ────→ 弹出登录提示对话框
    │
    └── 已登录
            │
            ▼
        执行乐观更新
        （立即显示"已安装"状态）
            │
            ▼
        调用安装 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 查询插件信息                         │
│ 3. 检查插件是否存在                     │
│ 4. 检查用户是否已安装                   │
│ 5. 检查安装权限                         │
│    - 企业插件需要权限                   │
│    - 收费插件需要已购买                 │
│ 6. 创建安装记录                         │
│ 7. 更新插件下载量                       │
│ 8. 重新验证相关页面缓存                 │
│ 9. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

### 3.2 安装权限检查逻辑

```
检查安装权限
    │
    ▼
插件来源类型？
    │
    ├── official（官方）────→ 检查价格类型
    │
    ├── personal（个人）────→ 检查价格类型
    │
    └── enterprise（企业）
            │
            ▼
        用户是否属于该企业？
            │
            ├── 否 ────→ 返回：无权访问此企业插件
            │
            └── 是
                    │
                    ▼
                用户是否有该插件权限？
                    │
                    ├── 否 ────→ 返回：请先申请使用权限
                    │
                    └── 是 ────→ 检查价格类型

检查价格类型
    │
    ▼
插件是否收费？
    │
    ├── 否（免费）────→ 允许安装
    │
    └── 是（收费）
            │
            ▼
        用户是否已购买（且未过期）？
            │
            ├── 否 ────→ 返回：请先购买此插件
            │
            └── 是 ────→ 允许安装
```

### 3.3 安装记录数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 记录 ID |
| userId | string | 用户 ID |
| pluginId | string | 插件 ID |
| versionId | string | 安装的版本 ID |
| runStatus | enum | 运行状态：running / stopped |
| installedAt | datetime | 安装时间 |
| updatedAt | datetime | 更新时间 |

---

## 4. 卸载插件

### 4.1 卸载流程

```
用户点击"卸载"按钮
    │
    ▼
弹出确认对话框
┌─────────────────────────────────────────┐
│  确定要卸载「插件名」吗？                │
│                                         │
│  卸载后您的个人配置将被清除。            │
│                                         │
│            [取消]  [确认卸载]           │
└─────────────────────────────────────────┘
    │
    ├── 取消 ────→ 关闭对话框
    │
    └── 确认
            │
            ▼
        执行乐观更新
        （立即显示"未安装"状态）
            │
            ▼
        调用卸载 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 查询安装记录                         │
│ 3. 检查是否已安装                       │
│ 4. 删除安装记录                         │
│ 5. 删除个人配置                         │
│ 6. 重新验证相关页面缓存                 │
│ 7. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

### 4.2 卸载清理内容

| 数据 | 是否清理 | 说明 |
|------|----------|------|
| 安装记录 | ✅ 删除 | UserPluginInstall 记录 |
| 个人配置 | ✅ 删除 | PersonalPluginConfig 记录 |
| 企业配置 | ❌ 保留 | 企业配置由管理员管理 |
| 购买记录 | ❌ 保留 | 重新安装时无需再次购买 |
| 权限记录 | ❌ 保留 | 重新安装时无需再次申请 |

---

## 5. 启动插件

### 5.1 启动流程

```
用户点击"启动"按钮
    │
    ▼
执行乐观更新
（立即显示"运行中"状态）
    │
    ▼
调用启动 Server Action
    │
    ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 查询安装记录                         │
│ 3. 检查插件是否已安装                   │
│ 4. 检查当前运行状态                     │
│ 5. 更新运行状态为 running              │
│ 6. 重新验证相关页面缓存                 │
│ 7. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

### 5.2 运行状态定义

| 状态 | 值 | 说明 | UI 显示 |
|------|-----|------|---------|
| 运行中 | running | 插件正在运行 | 绿色圆点 + "运行中" |
| 已停止 | stopped | 插件已停止 | 灰色圆点 + "已停止" |

---

## 6. 停止插件

### 6.1 停止流程

```
用户点击"停止"按钮
    │
    ▼
弹出确认对话框
┌─────────────────────────────────────────┐
│  确定要停止「插件名」吗？                │
│                                         │
│            [取消]  [确认停止]           │
└─────────────────────────────────────────┘
    │
    ├── 取消 ────→ 关闭对话框
    │
    └── 确认
            │
            ▼
        执行乐观更新
        （立即显示"已停止"状态）
            │
            ▼
        调用停止 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 查询安装记录                         │
│ 3. 检查插件是否已安装                   │
│ 4. 检查当前运行状态                     │
│ 5. 更新运行状态为 stopped              │
│ 6. 重新验证相关页面缓存                 │
│ 7. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

---

## 7. 更新插件

### 7.1 更新检测

**检测时机**：
- 进入插件详情页时
- 进入"我的插件"页面时

**检测逻辑**：
- 比较用户安装的版本与插件当前版本
- 如果当前版本 > 已安装版本，则显示更新提示

### 7.2 更新流程

```
用户点击"更新"按钮
    │
    ▼
弹出确认对话框
┌─────────────────────────────────────────┐
│  确定要更新「插件名」吗？                │
│                                         │
│  当前版本：v1.0.0                       │
│  最新版本：v1.2.0                       │
│                                         │
│  更新内容：                             │
│  • 新增 XXX 功能                        │
│  • 修复 YYY 问题                        │
│                                         │
│            [取消]  [确认更新]           │
└─────────────────────────────────────────┘
    │
    ├── 取消 ────→ 关闭对话框
    │
    └── 确认
            │
            ▼
        执行乐观更新
        （立即显示新版本号）
            │
            ▼
        调用更新 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 查询安装记录                         │
│ 3. 获取目标版本信息                     │
│ 4. 更新安装记录的 versionId            │
│ 5. 保留运行状态不变                     │
│ 6. 重新验证相关页面缓存                 │
│ 7. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ├── 成功 ────→ 确认乐观更新
    │              显示成功提示
    │
    └── 失败 ────→ 回滚乐观更新
                   显示错误提示
```

### 7.3 版本比较逻辑

**版本号格式**：`major.minor.patch`（如 1.2.3）

**比较规则**：
1. 先比较 major，大者为新
2. major 相同，比较 minor
3. minor 相同，比较 patch

---

## 8. 批量操作

### 8.1 支持的批量操作

| 操作 | 位置 | 说明 |
|------|------|------|
| 批量启动 | 我的插件页 | 启动选中的多个已停止插件 |
| 批量停止 | 我的插件页 | 停止选中的多个运行中插件 |
| 批量卸载 | 我的插件页 | 卸载选中的多个插件 |

### 8.2 批量操作流程

```
用户选中多个插件
    │
    ▼
点击批量操作按钮
    │
    ▼
弹出确认对话框
┌─────────────────────────────────────────┐
│  确定要批量{操作}以下插件吗？            │
│                                         │
│  • 插件 1                               │
│  • 插件 2                               │
│  • 插件 3                               │
│                                         │
│          [取消]  [确认{操作}]           │
└─────────────────────────────────────────┘
    │
    ├── 取消 ────→ 关闭对话框
    │
    └── 确认
            │
            ▼
        调用批量操作 Server Action
            │
            ▼
┌─────────────────────────────────────────┐
│           Server Action 处理            │
│                                         │
│ 1. 验证用户身份                         │
│ 2. 循环处理每个插件                     │
│ 3. 记录成功/失败数量                    │
│ 4. 重新验证相关页面缓存                 │
│ 5. 返回操作结果                         │
└─────────────────────────────────────────┘
    │
    ▼
显示操作结果
"成功{N}个，失败{M}个"
```

---

## 9. 错误处理

### 9.1 错误类型与处理

| 错误类型 | 错误码 | 用户提示 | 处理方式 |
|----------|--------|----------|----------|
| 未登录 | AUTH_REQUIRED | 请先登录 | 弹出登录提示 |
| 权限不足 | PERMISSION_DENIED | 您没有此操作的权限 | 显示错误提示 |
| 插件不存在 | PLUGIN_NOT_FOUND | 插件不存在 | 跳转到市场首页 |
| 已安装 | ALREADY_INSTALLED | 您已安装此插件 | 刷新页面状态 |
| 未安装 | NOT_INSTALLED | 您尚未安装此插件 | 刷新页面状态 |
| 需要购买 | PURCHASE_REQUIRED | 请先购买此插件 | 弹出购买对话框 |
| 需要权限 | PERMISSION_REQUIRED | 请先申请使用权限 | 弹出申请对话框 |
| 服务器错误 | SERVER_ERROR | 操作失败，请稍后重试 | 显示重试按钮 |

### 9.2 错误恢复机制

**乐观更新回滚**：
- 操作失败时，自动回滚 UI 状态到操作前
- 使用本地状态管理（useState）记录操作前状态

**页面刷新**：
- 某些错误（如状态不一致）建议用户刷新页面
- 提供"刷新"按钮或自动刷新

---

## 10. 操作日志（可选）

### 10.1 日志记录内容

| 字段 | 说明 |
|------|------|
| userId | 操作用户 ID |
| pluginId | 目标插件 ID |
| action | 操作类型 |
| status | 操作结果（成功/失败）|
| errorMessage | 失败时的错误信息 |
| createdAt | 操作时间 |
| ip | 用户 IP 地址 |
| userAgent | 用户浏览器信息 |

### 10.2 日志用途

- 用户操作历史查询
- 异常行为分析
- 故障排查
- 审计追踪
